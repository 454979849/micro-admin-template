const e="1.0.0-rc.6",t="undefined"!=typeof window,n="undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:Function("return this")(),o=()=>!1,r=Array.isArray,i=Object.assign,s=Object.defineProperty,a=Object.defineProperties,c=Object.prototype.toString,l=Object.prototype.hasOwnProperty,u=e=>c.call(e);function p(e){return void 0===e}function h(e){return null===e}function d(e){return"string"==typeof e}function m(e){return"boolean"==typeof e}function f(e){return"number"==typeof e}function _(e){return"function"==typeof e}function w(e){return"[object Object]"===u(e)}function g(e){return"[object Promise]"===u(e)}function A(e){var t;if(_(e)){const n=e.toString();return(null===(t=e.prototype)||void 0===t?void 0:t.constructor)===e&&Object.getOwnPropertyNames(e.prototype).length>1||/^function\s+[A-Z]/.test(n)||/^class\s+/.test(n)}return!1}function y(e){var t;return e instanceof URL||!!(null===(t=e)||void 0===t?void 0:t.href)}function b(e){var t;return e instanceof Element||d(null===(t=e)||void 0===t?void 0:t.tagName)}function v(e){var t;return e instanceof Node||f(null===(t=e)||void 0===t?void 0:t.nodeType)}function E(e){return"[object HTMLLinkElement]"===u(e)}function P(e){return"[object HTMLStyleElement]"===u(e)}function R(e){return"[object HTMLScriptElement]"===u(e)}function S(e){return"[object DocumentFragment]"===u(e)}function M(e){return b(e)&&"MICRO-APP-BODY"===e.tagName.toUpperCase()}function C(e,t){try{return x(e).pathname.split(".").pop()===t}catch(e){return!1}}function N(e,t,n){if(null==e)throw new TypeError("includes target is null or undefined");const o=Object(e),r=parseInt(o.length,10)||0;if(0===r)return!1;n=parseInt(n,10)||0;let i=Math.max(n>=0?n:r+n,0);for(;i<r;){if(t===o[i]||t!=t&&o[i]!=o[i])return!0;i++}return!1}function O(e,t=null,...n){const o=t&&d(t)?` app ${t}:`:"";d(e)?console.error(`[micro-app]${o} ${e}`,...n):console.error(`[micro-app]${o}`,e,...n)}function D(e,t=null,...n){const o=t&&d(t)?` app ${t}:`:"";d(e)?console.warn(`[micro-app]${o} ${e}`,...n):console.warn(`[micro-app]${o}`,e,...n)}function I(e,...t){Promise.resolve().then(e.bind(null,...t))}const x=function(){class e extends URL{}return(t,n)=>n?new e(""+t,n):new e(""+t)}();function L(e){return e.startsWith("//")?`${n.location.protocol}${e}`:e}function T(e,t=null){if(!d(e)||!e)return"";try{const{origin:t,pathname:n,search:o}=x(L(e),(window.rawWindow||window).location.href),r=`${t}${n}${o}`;return/^https?:\/\//.test(r)?r:""}catch(e){return O(e,t),""}}function W(e){return d(e)&&e?e.replace(/(^\d+)|([^\w\d-_])/gi,""):""}function U(e){const{origin:t,pathname:n}=x(e);if(/\.(\w+)$/.test(n)){const e=`${t}${n}`.split("/");return e.pop(),e.join("/")+"/"}return`${t}${n}/`.replace(/\/\/$/,"/")}function B(e,t){return!e||/^((((ht|f)tps?)|file):)?\/\//.test(e)||/^(data|blob):/.test(e)?e:x(e,U(L(t))).toString()}function k(e,t,n,o){let r=0;function i(){++r===e.length&&o&&o()}e.forEach(((e,o)=>{g(e)?e.then((e=>{t({data:e,index:o}),i()})).catch((e=>{n({error:e,index:o}),i()})):(t({data:e,index:o}),i())}))}const H=n.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),1)};function F(e){return new Promise((t=>{H((()=>{e(t)}))}))}let j=null;function $(e){j=e}function K(){return j}function q(e){j===e||Y()||($(e),I((()=>{$(null)})))}let G=null;function Q(e){G=e}function X(){return G}function z(e){G===e||Y()||(Q(e),I((()=>{Q(null)})))}let V=!1;function Y(){return V}function J(e){!1!==e?($(null),Q(null),e&&!V&&(V=!0,I((()=>{V=!1})))):V=!1}function Z(e,t){const n=(window.rawDocument||document).createElement(e,t);return n.__MICRO_APP_NAME__&&delete n.__MICRO_APP_NAME__,n.__PURE_ELEMENT__=!0,n}function ee(e){return!e||/(^\d)|([^\w\d-_\u4e00-\u9fa5])/gi.test(e)}function te(e){return/^body$/i.test(e)||/^head$/i.test(e)||/^html$/i.test(e)||/^title$/i.test(e)||/^:root$/i.test(e)}function ne(e){return function(e){return"undefined"!=typeof ShadowRoot&&e instanceof ShadowRoot}(e)?e.host:e}function oe(e){return e?e.replace(/^\s+|\s+$/g,""):""}function re(){return navigator.userAgent.indexOf("Firefox")>-1}function ie(e){const t={},n=e.split("&");for(const e of n){const n=e.indexOf("="),o=n<0?e:e.slice(0,n),i=n<0?null:e.slice(n+1);if(o in t){let e=t[o];r(e)||(e=t[o]=[e]),e.push(i)}else t[o]=i}return t}function se(e){let t="";for(const n in e){const o=e[n];if(h(o))t+=(t.length?"&":"")+n;else{(r(o)?o:[o]).forEach((e=>{p(e)||(t+=(t.length?"&":"")+n,h(e)||(t+="="+e))}))}}return t}function ae(){const e=new Set;return{add:function(t){return e.add(t),()=>!!e.has(t)&&e.delete(t)},list:()=>e}}function ce(e){const t=e.attributes,n=new Map;for(let e=0;e<t.length;e++)n.set(t[e].name,t[e].value);return n}function le(e,t){e?e.push((()=>F((e=>{t(),e()})))):t()}function ue(e){return(null==e?void 0:e.reduce(((e,t)=>e.then(t)),Promise.resolve()))||null}function pe(e){return e.startsWith("inline-")}function he(e,t,n,...o){try{_(e)&&e(...o)}catch(e){O(`An error occurred in app ${t} window.${n} \n`,null,e)}}const de=["mounted","unmount"];function me(e,t){return de.includes(e)?`${e}-${t}`:e}function fe(e,t,n,o){var r;if(!e)return D(`element does not exist in lifecycle ${n}`,t);e=ne(e),J();const s=i({name:t,container:e},o&&{error:o}),a=new CustomEvent(n,{detail:s});!function(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},target:{get:()=>t}})}(a,e),_(null===(r=vo.options.lifeCycles)||void 0===r?void 0:r[n])&&vo.options.lifeCycles[n](a,t),e.dispatchEvent(a)}function _e(e,t,n={}){var o;const r=new CustomEvent(me(t,e.name),{detail:n});null===(o=e.sandBox)||void 0===o||o.microAppWindow.dispatchEvent(r)}function we(e,t=null,n={}){return J(),_(vo.options.fetch)?vo.options.fetch(e,n,t):window.fetch(e,n).then((e=>e.text()))}class ge{static getInstance(){return this.instance||(this.instance=new ge),this.instance}run(e,t){const n=e.name,o=e.ssrUrl||e.url;(C(o,"js")?Promise.resolve(`<micro-app-head><script src='${o}'><\/script></micro-app-head><micro-app-body></micro-app-body>`):we(o,n,{cache:"no-cache"})).then((r=>{if(!r){const t="html is empty, please check in detail";return e.onerror(new Error(t)),O(t,n)}r=this.formatHTML(o,r,n),t(r,e)})).catch((t=>{O(`Failed to fetch data from ${e.url}, micro-app stop rendering`,n,t),e.onLoadError(t)}))}formatHTML(e,t,n){return this.processHtml(e,t,n,vo.options.plugins).replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<micro-app-head").replace(/<\/head>/i,"</micro-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<micro-app-body").replace(/<\/body>/i,"</micro-app-body>")))}processHtml(e,t,n,o){var r;if(!o)return t;const i=[];return o.global&&i.push(...o.global),(null===(r=o.modules)||void 0===r?void 0:r[n])&&i.push(...o.modules[n]),i.length>0?i.reduce(((t,n)=>w(n)&&_(n.processHtml)?n.processHtml(t,e):t),t):t}}const Ae=/(^|\s+)(html|:root)(?=[\s>~[.#:]+|$)/,ye=/(^|\s+)((html[\s>~]+body)|body)(?=[\s>~[.#:]+|$)/;function be(e,t){e=t?`${t} ${e}`:e;const n=new Error(e);throw n.reason=e,t&&(n.filename=t),n}class ve{constructor(){this.cssText="",this.prefix="",this.baseURI="",this.linkPath="",this.result="",this.scopecssDisable=!1,this.scopecssDisableSelectors=[],this.scopecssDisableNextLine=!1,this.mediaRule=this.createMatcherForRuleWithChildRule(/^@media *([^{]+)/,"@media"),this.supportsRule=this.createMatcherForRuleWithChildRule(/^@supports *([^{]+)/,"@supports"),this.documentRule=this.createMatcherForRuleWithChildRule(/^@([-\w]+)?document *([^{]+)/,"@document"),this.hostRule=this.createMatcherForRuleWithChildRule(/^@host\s*/,"@host"),this.importRule=this.createMatcherForNoneBraceAtRule("import"),this.charsetRule=this.createMatcherForNoneBraceAtRule("charset"),this.namespaceRule=this.createMatcherForNoneBraceAtRule("namespace"),this.containerRule=this.createMatcherForRuleWithChildRule(/^@container *([^{]+)/,"@container")}exec(e,t,n,o){return this.cssText=e,this.prefix=t,this.baseURI=n,this.linkPath=o||"",this.matchRules(),re()?decodeURIComponent(this.result):this.result}reset(){this.cssText=this.prefix=this.baseURI=this.linkPath=this.result="",this.scopecssDisable=this.scopecssDisableNextLine=!1,this.scopecssDisableSelectors=[]}matchRules(){for(this.matchLeadingSpaces(),this.matchComments();this.cssText.length&&"}"!==this.cssText.charAt(0)&&(this.matchAtRule()||this.matchStyleRule());)this.matchComments()}matchStyleRule(){const e=this.formatSelector(!0);return this.scopecssDisableNextLine=!1,e?(this.recordResult(e),this.matchComments(),this.styleDeclarations(),this.matchLeadingSpaces(),!0):be("selector missing",this.linkPath)}formatSelector(e){const t=this.commonMatch(/^[^{]+/,e);return!!t&&t[0].replace(/(^|,[\n\s]*)([^,]+)/g,((e,t,n)=>((n=oe(n))&&!(this.scopecssDisableNextLine||this.scopecssDisable&&(!this.scopecssDisableSelectors.length||this.scopecssDisableSelectors.includes(n))||Ae.test(n))&&(n=ye.test(n)?n.replace(ye,this.prefix+" micro-app-body"):this.prefix+" "+n),t+n)))}styleDeclarations(){return this.matchOpenBrace()?(this.matchAllDeclarations(),!!this.matchCloseBrace()||be("Declaration missing '}'",this.linkPath)):be("Declaration missing '{'",this.linkPath)}matchAllDeclarations(e=0){let t=this.commonMatch(/^(?:url\(["']?(?:[^)"'}]+)["']?\)|[^{}/])*/,!0)[0];if(t&&(this.scopecssDisableNextLine||this.scopecssDisable&&!this.scopecssDisableSelectors.length||(t=t.replace(/url\(["']?([^)"']+)["']?\)/gm,((e,t)=>/^((data|blob):|#|%23)/.test(t)||/^(https?:)?\/\//.test(t)?e:(/^((\.\.?\/)|[^/])/.test(t)&&this.linkPath&&(this.baseURI=function(e){const t=e.split("/");return t.pop(),L(t.join("/")+"/")}(this.linkPath)),`url("${B(t,this.baseURI)}")`)))),this.recordResult(t)),this.scopecssDisableNextLine=!1,this.cssText){if("/"===this.cssText.charAt(0))"*"===this.cssText.charAt(1)?this.matchComments():this.commonMatch(/\/+/);else if("{"===this.cssText.charAt(0))this.matchOpenBrace(),e++;else if("}"===this.cssText.charAt(0)){if(e<1)return;this.matchCloseBrace(),e--}return this.matchAllDeclarations(e)}}matchAtRule(){return"@"===this.cssText[0]&&(this.scopecssDisableNextLine=!1,this.keyframesRule()||this.mediaRule()||this.customMediaRule()||this.supportsRule()||this.importRule()||this.charsetRule()||this.namespaceRule()||this.containerRule()||this.documentRule()||this.pageRule()||this.hostRule()||this.fontFaceRule()||this.layerRule())}keyframesRule(){if(!this.commonMatch(/^@([-\w]+)?keyframes\s*/))return!1;if(!this.commonMatch(/^[^{]+/))return be("@keyframes missing name",this.linkPath);if(this.matchComments(),!this.matchOpenBrace())return be("@keyframes missing '{'",this.linkPath);for(this.matchComments();this.keyframeRule();)this.matchComments();return this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):be("@keyframes missing '}'",this.linkPath)}keyframeRule(){let e;const t=[];for(;e=this.commonMatch(/^((\d+\.\d+|\.\d+|\d+)%?|[a-z]+)\s*/);)t.push(e[1]),this.commonMatch(/^,\s*/);return!!t.length&&(this.styleDeclarations(),this.matchLeadingSpaces(),!0)}customMediaRule(){return!!this.commonMatch(/^@custom-media\s+(--[^\s]+)\s*([^{;]+);/)&&(this.matchLeadingSpaces(),!0)}pageRule(){return!!this.commonMatch(/^@page */)&&(this.formatSelector(!1),this.scopecssDisableNextLine=!1,this.commonHandlerForAtRuleWithSelfRule("page"))}fontFaceRule(){return!!this.commonMatch(/^@font-face\s*/)&&this.commonHandlerForAtRuleWithSelfRule("font-face")}layerRule(){return!!this.commonMatch(/^@layer\s*([^{;]+)/)&&(this.matchOpenBrace()?(this.matchComments(),this.matchRules(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):be("@layer missing '}'",this.linkPath)):!!this.commonMatch(/^[;]+/))}createMatcherForRuleWithChildRule(e,t){return()=>!!this.commonMatch(e)&&(this.matchOpenBrace()?(this.matchComments(),this.matchRules(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):be(`${t} missing '}'`,this.linkPath)):be(`${t} missing '{'`,this.linkPath))}createMatcherForNoneBraceAtRule(e){const t=new RegExp("^@"+e+"\\s*([^;]+);");return()=>!!this.commonMatch(t)&&(this.matchLeadingSpaces(),!0)}commonHandlerForAtRuleWithSelfRule(e){return this.matchOpenBrace()?(this.matchAllDeclarations(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):be(`@${e} missing '}'`,this.linkPath)):be(`@${e} missing '{'`,this.linkPath)}matchComments(){for(;this.matchComment(););}matchComment(){if("/"!==this.cssText.charAt(0)||"*"!==this.cssText.charAt(1))return!1;this.scopecssDisableNextLine=!1;let e=2;for(;""!==this.cssText.charAt(e)&&("*"!==this.cssText.charAt(e)||"/"!==this.cssText.charAt(e+1));)++e;if(e+=2,""===this.cssText.charAt(e-1))return be("End of comment missing",this.linkPath);let t=this.cssText.slice(2,e-2);if(this.recordResult(`/*${t}*/`),t=oe(t.replace(/^\s*!/,"")),"scopecss-disable-next-line"===t)this.scopecssDisableNextLine=!0;else if(/^scopecss-disable/.test(t))if("scopecss-disable"===t)this.scopecssDisable=!0;else{this.scopecssDisable=!0;t.replace("scopecss-disable","").split(",").forEach((e=>{this.scopecssDisableSelectors.push(oe(e))}))}else"scopecss-enable"===t&&(this.scopecssDisable=!1,this.scopecssDisableSelectors=[]);return this.cssText=this.cssText.slice(e),this.matchLeadingSpaces(),!0}commonMatch(e,t=!1){const n=e.exec(this.cssText);if(!n)return;const o=n[0];return this.cssText=this.cssText.slice(o.length),t||this.recordResult(o),n}matchOpenBrace(){return this.commonMatch(/^{\s*/)}matchCloseBrace(){return this.commonMatch(/^}\s*/)}matchLeadingSpaces(){this.commonMatch(/^\s*/)}recordResult(e){re()?this.result+=encodeURIComponent(e):this.result+=e}}function Ee(e,t,n,o,r){if(!e.__MICRO_APP_HAS_SCOPED__){e.__MICRO_APP_HAS_SCOPED__=!0;let i=null;try{i=Pe.exec(e.textContent,n,o,r),Pe.reset()}catch(e){Pe.reset(),O("An error occurred while parsing CSS:\n",t,e)}i&&(e.textContent=i)}}let Pe;function Re(e,t,n){if(t.scopecss){const o=Se(t.name);if(Pe||(Pe=new ve),e.textContent)Ee(e,t.name,o,t.url,n);else{const r=new MutationObserver((function(){r.disconnect(),e.textContent&&!e.hasAttribute("data-styled")&&Ee(e,t.name,o,t.url,n)}));r.observe(e,{childList:!0})}}return e}function Se(e,t=!1){const n=t?"\\":"";return`${vo.tagName}${n}[name=${e}${n}]`}function Me(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},srcElement:{get:()=>t},target:{get:()=>t}})}function Ce(e){const t=new CustomEvent("load");Me(t,e),_(e.onload)?e.onload(t):e.dispatchEvent(t)}function Ne(e){const t=new CustomEvent("error");Me(t,e),_(e.onerror)?e.onerror(t):e.dispatchEvent(t)}var Oe,De,Ie,xe,Le,Te,We=function(){const e=new Map,t=new Map;function n(e){return{setInfo(t,n){e.set(t,n)},getInfo(t){var n;return null!==(n=e.get(t))&&void 0!==n?n:null},hasInfo:t=>e.has(t),deleteInfo:t=>e.delete(t)}}return{link:n(e),script:Object.assign(Object.assign({},n(t)),{deleteInlineInfo(e){e.forEach((e=>{pe(e)&&t.delete(e)}))}})}}();function Ue(e,t,n,o=!1){const r=e.getAttribute("rel");let i=e.getAttribute("href"),s=null;if("stylesheet"===r&&i){i=B(i,n.url);let t=We.link.getInfo(i);const r={attrs:ce(e)};if(t?t.appSpace[n.name]=t.appSpace[n.name]||r:t={code:"",appSpace:{[n.name]:r}},We.link.setInfo(i,t),o)return{address:i,linkInfo:t};n.source.links.add(i),s=document.createComment(`link element with href=${i} move to micro-app-head as style element`),t.appSpace[n.name].placeholder=s}else r&&["prefetch","preload","prerender","modulepreload","icon"].includes(r)?o?s=document.createComment(`link element with rel=${r}${i?" & href="+i:""} removed by micro-app`):null==t||t.removeChild(e):i&&lo.rawSetAttribute.call(e,"href",B(i,n.url));return o?{replaceComment:s}:s?null==t?void 0:t.replaceChild(s,e):void 0}function Be(e,t,n,o){const r=Array.from(t.source.links),i=r.map((e=>{const n=We.link.getInfo(e);return n.code?n.code:we(e,t.name)})),s=o?[]:null;k(i,(e=>{le(s,(()=>function(e,t,n,o){const r=We.link.getInfo(e);r.code=t;const i=r.appSpace[o.name],s=i.placeholder;if(s){const t=Z("style");ke(o,e,t,r,i.attrs),s.parentNode?s.parentNode.replaceChild(t,s):n.appendChild(t),i.placeholder=null}}(r[e.index],e.data,n,t)))}),(e=>{O(e,t.name)}),(()=>{o?o.then((()=>{s.push((()=>Promise.resolve(t.onLoad({html:e})))),ue(s)})):t.onLoad({html:e})}))}function ke(e,t,n,o,r){if(e.scopecss){const r=o.appSpace[e.name];if(r.prefix=r.prefix||Se(e.name),r.parsedCode)n.textContent=r.parsedCode;else{const i=function(e,t,n){const o=n.appSpace;for(const n in o)if(n!==e){const e=o[n];if(e.parsedCode)return e.parsedCode.replace(new RegExp(Se(n,!0),"g"),t)}}(e.name,r.prefix,o);i?n.textContent=i:(n.textContent=o.code,Re(n,e,t)),r.parsedCode=n.textContent}}else n.textContent=o.code;!function(e,t){t.forEach(((t,n)=>{"rel"!==n&&("href"===n&&(n="data-origin-href"),lo.rawSetAttribute.call(e,n,t))}))}(n,r)}!function(e){e.NAME="name",e.URL="url"}(Oe||(Oe={})),function(e){e.CREATED="created",e.LOADING="loading",e.LOAD_FAILED="load_failed",e.BEFORE_MOUNT="before_mount",e.MOUNTING="mounting",e.MOUNTED="mounted",e.UNMOUNT="unmount"}(De||(De={})),function(e){e.CREATED="created",e.BEFOREMOUNT="beforemount",e.MOUNTED="mounted",e.UNMOUNT="unmount",e.ERROR="error",e.BEFORESHOW="beforeshow",e.AFTERSHOW="aftershow",e.AFTERHIDDEN="afterhidden"}(Ie||(Ie={})),function(e){e.ONMOUNT="onmount",e.ONUNMOUNT="onunmount"}(xe||(xe={})),function(e){e.KEEP_ALIVE_SHOW="keep_alive_show",e.KEEP_ALIVE_HIDDEN="keep_alive_hidden"}(Le||(Le={})),function(e){e.DESTROY="destroy",e.DESTORY="destory",e.INLINE="inline",e.DISABLESCOPECSS="disableScopecss",e.DISABLESANDBOX="disableSandbox",e.DISABLE_SCOPECSS="disable-scopecss",e.DISABLE_SANDBOX="disable-sandbox",e.DISABLE_MEMORY_ROUTER="disable-memory-router",e.DISABLE_PATCH_REQUEST="disable-patch-request",e.KEEP_ROUTER_STATE="keep-router-state",e.KEEP_ALIVE="keep-alive",e.CLEAR_DATA="clear-data",e.SSR="ssr",e.FIBER="fiber"}(Te||(Te={}));const He="window,self,globalThis,document,Document,Array,Object,String,Boolean,Math,Number,Symbol,Date,Function,Proxy,WeakMap,WeakSet,Set,Map,Reflect,Element,Node,RegExp,Error,TypeError,JSON,isNaN,parseFloat,parseInt,performance,console,decodeURI,encodeURI,decodeURIComponent,encodeURIComponent,navigator,undefined,location,history",Fe=[1,2,3],je="state",$e="search",Ke="native",qe="native-scope",Ge="pure",Qe=[$e,je,Ke,qe,Ge],Xe=["popstate","hashchange","load","unload","unmount","appstate-change","statechange","mounted"],ze=Xe,Ve=Xe.concat(["unhandledrejection","message"]),Ye=["onpopstate","onhashchange","onload","onunload","onerror"],Je=Ye,Ze=Ye.concat(["onunhandledrejection"]),et=["DOMContentLoaded","readystatechange"],tt=["onreadystatechange"],nt=["window","self","globalThis"],ot=["rawWindow","rawDocument"],rt=["host","hostname","port","protocol","origin"],it=["text/javascript","text/ecmascript","application/javascript","application/ecmascript","module","systemjs-module","systemjs-importmap"];function st(e,t){return t.appSpace[e.name].module&&(!e.useSandbox||e.iframe)}function at(e,t){return e.inline||t.appSpace[e.name].inline||st(e,t)||function(e,t){return t.appSpace[e.name].attrs.has("id")}(e,t)}function ct(e){return e.iframe?e.sandBox.microAppWindow:lo.rawWindow}function lt(e,t,n){return function(e,t,n){const o=t.appSpace;for(const t in o)if(t!==e.name){const e=o[t];if(e.parsedCode===n&&e.parsedFunction)return e.parsedFunction}}(e,t,n)||function(e,t){return new(ct(e).Function)(t)}(e,n)}function ut(){const e="inline-"+Math.random().toString(36).substr(2,15);return We.script.hasInfo(e)?ut():e}function pt(e,t){return e.useSandbox&&!st(e,t)}function ht(e,t){return pt(e,t)?e.iframe?"iframe":"with":"disable"}function dt(e,t,n,o=!1){var r;let i=null,s=e.getAttribute("src");if(s&&(s=B(s,n.url)),e.hasAttribute("exclude")||ft(s,n.name))i=document.createComment("script element with exclude attribute removed by micro-app");else{if(e.type&&!it.includes(e.type)||e.hasAttribute("ignore")||_t(s,n.name))return(null===(r=lo.rawDocument)||void 0===r?void 0:r.currentScript)&&delete lo.rawDocument.currentScript,null;if(lo.supportModuleScript&&e.noModule||!lo.supportModuleScript&&"module"===e.type)i=document.createComment((e.noModule?"noModule":"module")+" script ignored by micro-app");else if(s){let t=We.script.getInfo(s);const r={async:e.hasAttribute("async"),defer:e.defer||"module"===e.type,module:"module"===e.type,inline:e.hasAttribute("inline"),pure:e.hasAttribute("pure"),attrs:ce(e)};if(t?t.appSpace[n.name]=t.appSpace[n.name]||r:t={code:"",isExternal:!0,appSpace:{[n.name]:r}},We.script.setInfo(s,t),o)return{address:s,scriptInfo:t};n.source.scripts.add(s),i=document.createComment(`script with src='${s}' extract by micro-app`)}else if(e.textContent){const t=ut(),r={code:e.textContent,isExternal:!1,appSpace:{[n.name]:{async:!1,defer:"module"===e.type,module:"module"===e.type,inline:e.hasAttribute("inline"),pure:e.hasAttribute("pure"),attrs:ce(e)}}};if(o)return{address:t,scriptInfo:r};n.source.scripts.add(t),We.script.setInfo(t,r),i=document.createComment("inline script extract by micro-app")}else o||(i=document.createComment("script element removed by micro-app"))}return o?{replaceComment:i}:null==t?void 0:t.replaceChild(i,e)}function mt(e){var t,n,o;return[...(null===(t=vo.options.plugins)||void 0===t?void 0:t.global)||[],...(null===(o=null===(n=vo.options.plugins)||void 0===n?void 0:n.modules)||void 0===o?void 0:o[e])||[]]}function ft(e,t){if(!e)return!1;return(mt(t)||[]).some((t=>!!t.excludeChecker&&t.excludeChecker(e)))}function _t(e,t){if(!e)return!1;return(mt(t)||[]).some((t=>!!t.ignoreChecker&&t.ignoreChecker(e)))}function wt(e,t){const n=Array.from(t.source.scripts),o=[],r=[];for(const e of n){const n=We.script.getInfo(e),i=n.appSpace[t.name];(!i.defer&&!i.async||t.isPrefetch&&!t.isPrerender)&&(o.push(n.code?n.code:we(e,t.name)),r.push([e,n]))}const i=t.isPrefetch||t.fiber?[]:null;o.length?k(o,(e=>{le(i,(()=>function(e,t,n,o){if(t.code=n,o.isPrefetch&&2===o.prefetchLevel){const r=t.appSpace[o.name];if(!r.parsedCode&&(r.parsedCode=At(e,o,n,t),r.sandboxType=ht(o,t),!at(o,t)))try{r.parsedFunction=lt(o,t,r.parsedCode)}catch(e){O("Something went wrong while handling preloaded resources",o.name,"\n",e)}}}(r[e.index][0],r[e.index][1],e.data,t)))}),(e=>{O(e,t.name)}),(()=>{i?(i.push((()=>Promise.resolve(t.onLoad({html:e})))),ue(i)):t.onLoad({html:e})})):t.onLoad({html:e})}function gt(e,t,n,o,r){var i;try{!function(e){!function(e){e.sandBox&&(lo.rawWindow.__MICRO_APP_PROXY_WINDOW__=e.sandBox.proxyWindow)}(e)}(t);const s=n.appSpace[t.name],a=ht(t,n);if(s.parsedCode&&s.sandboxType===a||(s.parsedCode=At(e,t,n.code,n),s.sandboxType=a,s.parsedFunction=null),at(t,n)){const a=r||Z("script");if(function(e,t,n,o,r,i){if(n){if(lo.rawSetAttribute.call(o,"type","module"),pe(e)?o.textContent=t:o.src=e,i){const t=()=>{i.moduleCount&&i.moduleCount--,i(0===i.moduleCount)};pe(e)?I(t):o.onload=t}}else o.textContent=t;!function(e,t){t.forEach(((t,n)=>{"type"===n&&"module"===t||"defer"===n||"async"===n||("src"===n&&(n="data-origin-src"),lo.rawSetAttribute.call(e,n,t))}))}(o,r)}(e,s.parsedCode,st(t,n),a,s.attrs,o),!r){const e=t.iframe?null===(i=t.sandBox)||void 0===i?void 0:i.microBody:t.querySelector("micro-app-body");null==e||e.appendChild(a)}}else!function(e,t){const n=t.appSpace[e.name];n.parsedFunction||(n.parsedFunction=lt(e,t,n.parsedCode));n.parsedFunction.call(ct(e))}(t,n)}catch(n){throw console.error(`[micro-app from ${r?"runDynamicScript":"runScript"}] app ${t.name}: `,n,e),n}}function At(e,t,n,o){return w(vo.options.plugins)&&(n=function(e,t,n,o){var r;const i=yt(o.global,t,e);return yt(null===(r=o.modules)||void 0===r?void 0:r[n],i,e)}(e,n,t.name,vo.options.plugins)),pt(t,o)?t.iframe?`(function(window,self,global,location){;${n}\n${pe(e)?"":`//# sourceURL=${e}\n`}}).call(window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyWindow,window.__MICRO_APP_SANDBOX__.proxyLocation);`:`;(function(proxyWindow){with(proxyWindow.__MICRO_APP_WINDOW__){(function(${He}){;${n}\n${pe(e)?"":`//# sourceURL=${e}\n`}}).call(proxyWindow,${He})}})(window.__MICRO_APP_PROXY_WINDOW__);`:n}function yt(e,t,n){return r(e)?e.reduce(((e,t)=>w(t)&&_(t.loader)?t.loader(e,n):e),t):t}function bt(e,t,n,o){const r=Array.from(e.children);r.length&&r.forEach((e=>{bt(e,t,n,o)}));for(const n of r)E(n)?n.hasAttribute("exclude")||ft(n.getAttribute("href"),t.name)?e.replaceChild(document.createComment("link element with exclude attribute ignored by micro-app"),n):n.hasAttribute("ignore")||_t(n.getAttribute("href"),t.name)?n.hasAttribute("href")&&lo.rawSetAttribute.call(n,"href",B(n.getAttribute("href"),t.url)):Ue(n,e,t):P(n)?n.hasAttribute("exclude")?e.replaceChild(document.createComment("style element with exclude attribute ignored by micro-app"),n):t.scopecss&&!n.hasAttribute("ignore")&&le(o,(()=>Re(n,t))):R(n)?dt(n,e,t):"[object HTMLImageElement]"===u(n)&&n.hasAttribute("src")&&lo.rawSetAttribute.call(n,"src",B(n.getAttribute("src"),t.url))}function vt(e,t){const n=t.parseHtmlString(e),o=lo.rawElementQuerySelector.call(n,"micro-app-head"),r=lo.rawElementQuerySelector.call(n,"micro-app-body");if(!o||!r){const e=`element ${o?"body":"head"} is missing`;return t.onerror(new Error(e)),O(e,t.name)}const i=t.isPrefetch||t.fiber?[]:null;bt(n,t,o,i);const s=ue(i);t.source.links.size?Be(n,t,o,s):s?s.then((()=>t.onLoad({html:n}))):t.onLoad({html:n}),t.source.scripts.size?wt(n,t):t.onLoad({html:n})}const Et=new class{constructor(){this.eventList=new Map,this.queue=[],this.recordStep={},this.process=()=>{var e,t;let n;const o=this.recordStep,r=this.queue;for(this.recordStep={},this.queue=[];n=r.shift();){const r=this.eventList.get(n),i=r.tempData,s=r.force;let a;if(r.tempData=null,r.force=!1,s||!this.isEqual(r.data,i)){r.data=i||r.data;for(const e of r.callbacks){const t=e(r.data);t&&(null!=a?a:a=[]).push(t)}null===(t=(e=o[n]).dispatchDataEvent)||void 0===t||t.call(e),o[n].nextStepList.forEach((e=>e(a)))}}}}isLegalName(e){return!!e||(O("event-center: Invalid name"),!1)}enqueue(e,t,n){this.recordStep[e]?(this.recordStep[e].nextStepList.push(t),n&&(this.recordStep[e].dispatchDataEvent=n)):this.recordStep[e]={nextStepList:[t],dispatchDataEvent:n},!this.queue.includes(e)&&1===this.queue.push(e)&&I(this.process)}isEqual(e,t){if(!t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&e[n]!==t[n])return!1;return!0}on(e,t,n=!1){if(this.isLegalName(e)){if(!_(t))return O("event-center: Invalid callback function");let o=this.eventList.get(e);o?n&&Object.keys(o.data).length&&(!this.queue.includes(e)||this.isEqual(o.data,o.tempData))&&t(o.data):(o={data:{},callbacks:new Set},this.eventList.set(e,o)),o.callbacks.add(t)}}off(e,t){if(this.isLegalName(e)){const n=this.eventList.get(e);n&&(_(t)?n.callbacks.delete(t):n.callbacks.clear())}}clearData(e){if(this.isLegalName(e)){const t=this.eventList.get(e);t&&(t.data={})}}dispatch(e,t,n,o,r){if(this.isLegalName(e)){if(!w(t))return O("event-center: data must be object");let s=this.eventList.get(e);s?(s.tempData=i({},s.tempData||s.data,t),!s.force&&(s.force=!!o)):(s={data:t,callbacks:new Set},this.eventList.set(e,s),s.force=!0),this.enqueue(e,n,r)}}getData(e){var t;const n=this.eventList.get(e);return null!==(t=null==n?void 0:n.data)&&void 0!==t?t:null}};function Pt(e,t){return d(e)&&e?t?`__${e}_from_base_app__`:`__${e}_from_micro_app__`:""}class Rt{addGlobalDataListener(e,t){const n=this.appName;n&&(e.__APP_NAME__=n,e.__AUTO_TRIGGER__=t),Et.on("global",e,t)}removeGlobalDataListener(e){_(e)&&Et.off("global",e)}setGlobalData(e,t,n){J(),Et.dispatch("global",e,(e=>_(t)&&t(e)),n)}forceSetGlobalData(e,t){this.setGlobalData(e,t,!0)}getGlobalData(){return Et.getData("global")}clearGlobalData(){Et.clearData("global")}clearGlobalDataListener(){const e=this.appName,t=Et.eventList.get("global");if(t)for(const n of t.callbacks)(e&&e===n.__APP_NAME__||!e&&!n.__APP_NAME__)&&t.callbacks.delete(n)}}class St extends Rt{addDataListener(e,t,n){Et.on(Pt(W(e),!1),t,n)}removeDataListener(e,t){_(t)&&Et.off(Pt(W(e),!1),t)}getData(e,t=!1){return Et.getData(Pt(W(e),t))}setData(e,t,n,o){Et.dispatch(Pt(W(e),!0),t,(e=>_(n)&&n(e)),o)}forceSetData(e,t,n){this.setData(e,t,n,!0)}clearData(e,t=!0){Et.clearData(Pt(W(e),t))}clearDataListener(e){Et.off(Pt(W(e),!1))}}class Mt extends Rt{constructor(e){super(),this.appName=W(e),!this.appName&&O(`Invalid appName ${e}`)}addDataListener(e,t){e.__AUTO_TRIGGER__=t,Et.on(Pt(this.appName,!0),e,t)}removeDataListener(e){_(e)&&Et.off(Pt(this.appName,!0),e)}getData(e=!0){return Et.getData(Pt(this.appName,e))}dispatch(e,t,n){J(),Et.dispatch(Pt(this.appName,!1),e,(e=>_(t)&&t(e)),n,(()=>{const t=zn.get(this.appName);if((null==t?void 0:t.container)&&w(e)){const e=new CustomEvent("datachange",{detail:{data:Et.getData(Pt(this.appName,!1))}});ne(t.container).dispatchEvent(e)}}))}forceDispatch(e,t){this.dispatch(e,t,!0)}clearData(e=!1){Et.clearData(Pt(this.appName,e))}clearDataListener(){Et.off(Pt(this.appName,!0))}}function Ct(e){var t,n;if(e){e.umdDataListeners={global:new Set(null===(t=e.umdDataListeners)||void 0===t?void 0:t.global),normal:new Set(null===(n=e.umdDataListeners)||void 0===n?void 0:n.normal)};const o=Et.eventList.get("global");if(o)for(const t of o.callbacks)e.appName===t.__APP_NAME__&&e.umdDataListeners.global.add(t);const r=Et.eventList.get(Pt(e.appName,!0));if(r)for(const t of r.callbacks)e.umdDataListeners.normal.add(t)}}function Nt(e){if(null==e?void 0:e.umdDataListeners){for(const t of e.umdDataListeners.global)e.addGlobalDataListener(t,t.__AUTO_TRIGGER__);for(const t of e.umdDataListeners.normal)e.addDataListener(t,t.__AUTO_TRIGGER__);Ot(e)}}function Ot(e){null==e||delete e.umdDataListeners}class Dt{constructor(){this.appInstanceMap=zn}static getInstance(){return this.instance||(this.instance=new Dt),this.instance}get(e){return this.appInstanceMap.get(e)}set(e,t){this.appInstanceMap.set(e,t)}getAll(){return Array.from(this.appInstanceMap.values())}clear(){this.appInstanceMap.clear()}}function It(){xt(),Dt.getInstance().getAll().forEach((e=>{e.container&&ne(e.container).disconnectedCallback()})),!window.__MICRO_APP_UMD_MODE__&&Dt.getInstance().clear()}function xt(){window.__MICRO_APP_ENVIRONMENT__&&window.removeEventListener("unmount",It,!1)}function Lt(e){return m(e.__MICRO_APP_IS_BOUND_FUNCTION__)?e.__MICRO_APP_IS_BOUND_FUNCTION__:e.__MICRO_APP_IS_BOUND_FUNCTION__=_(t=e)&&0===(null===(n=t.name)||void 0===n?void 0:n.indexOf("bound "))&&!t.hasOwnProperty("prototype");var t,n}function Tt(e,t,n="WINDOW"){if(_(e)&&!function(e){return m(e.__MICRO_APP_IS_CONSTRUCTOR__)?e.__MICRO_APP_IS_CONSTRUCTOR__:e.__MICRO_APP_IS_CONSTRUCTOR__=A(e)}(e)&&!Lt(e)&&e.bind){const o=`__MICRO_APP_BOUND_${n}_FUNCTION__`;if(e[o])return e[o];const r=e.bind(t);for(const t in e)r[t]=e[t];return e.hasOwnProperty("prototype")&&s(r,"prototype",{value:e.prototype,configurable:!0,enumerable:!1,writable:!0}),e[o]=r}return e}class Wt{constructor(e,t){this.rawWindowScopeKeyList=["location"],this.staticEscapeProperties=["System","__cjsWrapper"],this.staticScopeProperties=["webpackJsonp","webpackHotUpdate","Vue","onpopstate","onhashchange"],this.scopeProperties=Array.from(this.staticScopeProperties),this.escapeProperties=[],this.injectedKeys=new Set,this.escapeKeys=new Set,this.appName=e,this.url=t}}class Ut{}function Bt(e,t){const n=Array.from(e.childNodes);n.length&&n.forEach((e=>{Bt(e,t)})),kt(e,t)}function kt(e,t){var n,o;if(t&&v(e)&&e.__MICRO_APP_NAME__!==t&&!e.__PURE_ELEMENT__&&!Y()&&(a(e,{__MICRO_APP_NAME__:{configurable:!0,enumerable:!0,writable:!0,value:t}}),Yn(t))){const r=null===(o=null===(n=zn.get(t))||void 0===n?void 0:n.sandBox)||void 0===o?void 0:o.proxyWindow;r&&a(e,{baseURI:{configurable:!0,enumerable:!0,get:()=>r.location.href},ownerDocument:{configurable:!0,enumerable:!0,get:()=>e!==r.document?r.document:null},parentNode:Ht(t,lo.rawParentNodeDesc),getRootNode:{configurable:!0,enumerable:!0,writable:!0,value:function(){return r.document}}})}return e}function Ht(e,t){return{configurable:!0,enumerable:!0,get(){var n,o,r,i;z(e);const s=null===(n=t.get)||void 0===n?void 0:n.call(this);return M(s)&&(null===(o=zn.get(e))||void 0===o?void 0:o.container)?(null===(i=(r=vo.options).getRootElementParentNode)||void 0===i?void 0:i.call(r,this,e))||lo.rawDocument.body:s}}}function Ft(e,t,n){const{proxyDocument:o,documentEffect:r}=function(e,t){const n=new Map,o=new Map;let r=null,i=null;const{rawDocument:s,rawCreateElement:a,rawCreateElementNS:c,rawAddEventListener:l,rawRemoveEventListener:u}=lo;function p(t,n){return kt(a.call(s,t,n),e)}function h(t,n,o){return kt(c.call(s,t,n,o),e)}function d(e,t,o){const r=n.get(e);r?r.add(t):n.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=o),l.call(s,e,t,o)}function m(e,t,o){const r=n.get(e);(null==r?void 0:r.size)&&r.has(t)&&r.delete(t),u.call(s,e,t,o)}const f=()=>{o.clear(),i=null},w=()=>{i=r||i,n.forEach(((e,t)=>{if(e.size){const n=o.get(t)||[];o.set(t,new Set([...n,...e]))}}))},g=()=>{i&&!r&&(b.onclick=i),o.forEach(((e,t)=>{for(const n of e)b.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),f()},A=()=>{_(r)&&u.call(s,"click",r),r=null,n.size&&(n.forEach(((e,t)=>{for(const n of e)u.call(s,t,n)})),n.clear())},y=(()=>{var e;const t=new Map([["onclick",e=>{_(r)&&u.call(s,"click",r,!1),_(e)&&l.call(s,"click",e,!1),r=e}]]),n=(null===(e=vo.options)||void 0===e?void 0:e.customProxyDocumentProps)||new Map;return new Map([...t,...n])})(),b=new Proxy(s,{get:(n,o)=>{var i;return q(e),"createElement"===o?p:"createElementNS"===o?h:o===Symbol.toStringTag?"ProxyDocument":"defaultView"===o?t.proxyWindow:"onclick"===o?r:"addEventListener"===o?d:"removeEventListener"===o?m:"microAppElement"===o?null===(i=zn.get(e))||void 0===i?void 0:i.container:"__MICRO_APP_NAME__"===o?e:Tt(Reflect.get(n,o),s,"DOCUMENT")},set:(e,t,n)=>{if(y.has(t)){y.get(t)(n)}else"microAppElement"!==t&&Reflect.set(e,t,n);return!0}});return{proxyDocument:b,documentEffect:{reset:f,record:w,rebuild:g,release:A}}}(e,n),i=function(e,t){const{rawDocument:n,rawRootDocument:o}=lo;class r{static[Symbol.hasInstance](e){let n=e;for(;n;)if(n=Object.getPrototypeOf(n),n===r.prototype)return!0;return e===t||e instanceof o}}return Object.setPrototypeOf(r,o),Object.setPrototypeOf(r.prototype,new Proxy(o.prototype,{get:(t,o)=>(q(e),Tt(Reflect.get(t,o),n,"DOCUMENT")),set:(e,t,n)=>(Reflect.set(e,t,n),!0)})),r}(e,o);return a(t,{document:{configurable:!1,enumerable:!0,get:()=>o},Document:{configurable:!1,enumerable:!1,get:()=>i}}),r}function jt(e,t,n){return function(e){const t=lo.rawWindow;Object.getOwnPropertyNames(t).filter((e=>/^on/.test(e)&&!Je.includes(e))).forEach((n=>{const{enumerable:o,writable:r,set:i}=Object.getOwnPropertyDescriptor(t,n)||{enumerable:!0,writable:!0};s(e,n,{enumerable:o,configurable:!0,get:()=>t[n],set:(null!=r?r:i)?e=>{t[n]=e}:void 0})}))}(t),function(e,t,n){const o=lo.rawWindow,r=new Map,i=new Proxy(t,{get:(t,r)=>(q(e),Reflect.has(t,r)||d(r)&&/^__MICRO_APP_/.test(r)||N(n.scopeProperties,r)?(N(ot,r)&&J(),Reflect.get(t,r)):Tt(Reflect.get(o,r),o)),set:(e,t,r)=>{if(N(n.rawWindowScopeKeyList,t))Reflect.set(o,t,r);else if(l.call(e,t)||!l.call(o,t)||N(n.scopeProperties,t))Reflect.has(e,t)&&!N(n.scopeProperties,t)||n.injectedKeys.add(t),Reflect.set(e,t,r);else{const i=Object.getOwnPropertyDescriptor(o,t),{configurable:a,enumerable:c,writable:l,set:u}=i;s(e,t,{value:r,configurable:a,enumerable:c,writable:null!=l?l:!!u}),n.injectedKeys.add(t)}return(N(n.escapeProperties,t)||N(n.staticEscapeProperties,t)&&!Reflect.has(o,t))&&!N(n.scopeProperties,t)&&(!Reflect.has(o,t)&&n.escapeKeys.add(t),Reflect.set(o,t,r)),!0},has:(e,t)=>N(n.scopeProperties,t)?n.injectedKeys.has(t)?Reflect.has(e,t):!!e[t]:Reflect.has(e,t)||Reflect.has(o,t),getOwnPropertyDescriptor:(e,t)=>{if(l.call(e,t))return r.set(t,"target"),Object.getOwnPropertyDescriptor(e,t);if(l.call(o,t)){r.set(t,"rawWindow");const e=Object.getOwnPropertyDescriptor(o,t);return e&&!e.configurable&&(e.configurable=!0),e}},defineProperty:(e,t,n)=>"rawWindow"===r.get(t)?Reflect.defineProperty(o,t,n):Reflect.defineProperty(e,t,n),ownKeys:e=>Reflect.ownKeys(o).concat(Reflect.ownKeys(e)).filter((function(e){return!(e in this)&&(this[e]=!0)}),Object.create(null)),deleteProperty:(e,t)=>!l.call(e,t)||(n.injectedKeys.has(t)&&n.injectedKeys.delete(t),n.escapeKeys.has(t)&&Reflect.deleteProperty(o,t),Reflect.deleteProperty(e,t))});n.proxyWindow=i}(e,t,n),function(e,t){const n=new Map,o=new Map,r=new Map,i=new Map,{rawWindow:s,rawAddEventListener:a,rawRemoveEventListener:c,rawDispatchEvent:l,rawSetInterval:u,rawSetTimeout:p,rawClearInterval:h,rawClearTimeout:d}=lo;function m(e){var n;return ze.includes(e)&&(null===(n=zn.get(t))||void 0===n?void 0:n.container)?ne(zn.get(t).container):s}e.addEventListener=function(e,o,r){e=me(e,t);const i=n.get(e);i?i.add(o):n.set(e,new Set([o])),o&&(o.__MICRO_APP_MARK_OPTIONS__=r),a.call(m(e),e,o,r)},e.removeEventListener=function(e,o,r){e=me(e,t);const i=n.get(e);(null==i?void 0:i.size)&&i.has(o)&&i.delete(o),c.call(m(e),e,o,r)},e.dispatchEvent=function(e){return l.call(m(null==e?void 0:e.type),e)},e.setInterval=function(e,t,...n){const o=u.call(s,e,t,...n);return r.set(o,{handler:e,timeout:t,args:n}),o},e.setTimeout=function(e,t,...n){const o=p.call(s,e,t,...n);return i.set(o,{handler:e,timeout:t,args:n}),o},e.clearInterval=function(e){r.delete(e),h.call(s,e)},e.clearTimeout=function(e){i.delete(e),d.call(s,e)};const f=()=>{o.clear()},_=()=>{o.forEach(((t,n)=>{for(const o of t)e.addEventListener(n,o,null==o?void 0:o.__MICRO_APP_MARK_OPTIONS__)})),f()};return{reset:f,record:()=>{n.forEach(((e,t)=>{if(e.size){const n=o.get(t)||[];o.set(t,new Set([...n,...e]))}}))},rebuild:_,release:e=>{n.size&&(n.forEach(((e,t)=>{for(const n of e)c.call(m(t),t,n)})),n.clear()),e&&(r.forEach(((e,t)=>{h.call(s,t)})),i.forEach(((e,t)=>{d.call(s,t)})),r.clear(),i.clear())}}}(t,e)}function $t(e,t,n){const o=lo.rawWindow.history.state,r={__MICRO_APP_STATE__:i({},null==o?void 0:o.__MICRO_APP_STATE__,{[e]:{fullPath:n?n.pathname+n.search+n.hash:null,state:null!=t?t:null,mode:rn(e)}})};return i({},o,r)}function Kt(e,t){return w(null==t?void 0:t.__MICRO_APP_STATE__)&&(p(t.__MICRO_APP_STATE__[e])||delete t.__MICRO_APP_STATE__[e],Object.keys(t.__MICRO_APP_STATE__).length||delete t.__MICRO_APP_STATE__),w(n=t)&&Object.keys(n).length?i({},t):null;var n}function qt(e){var t,n;const o=lo.rawWindow.history.state;return(null===(n=null===(t=null==o?void 0:o.__MICRO_APP_STATE__)||void 0===t?void 0:t[e])||void 0===n?void 0:n.state)||null}function Gt(e){var t;const n=lo.rawWindow.history.state;return(null===(t=null==n?void 0:n.__MICRO_APP_STATE__)||void 0===t?void 0:t[e])||null}const Qt=/&/g,Xt=/=/g,zt=/%M1/g,Vt=/%M2/g;function Yt(e){return encodeURIComponent(Zt(e).replace(Qt,"%M1").replace(Xt,"%M2"))}function Jt(e){return Zt(e).replace(zt,"&").replace(Vt,"=")}function Zt(e){try{const t=decodeURIComponent(e);return e===t||zt.test(t)||Vt.test(t)?t:Zt(t)}catch(t){return e}}function en(e){var t,n,o,r;const i=lo.rawWindow.location,s=lo.rawWindow.history.state;if(sn(e)){const o=nn(i.search,i.hash),r=(null===(t=o.hashQuery)||void 0===t?void 0:t[e])||(null===(n=o.searchQuery)||void 0===n?void 0:n[e]);return d(r)?Jt(r):null}return(null===(r=null===(o=null==s?void 0:s.__MICRO_APP_STATE__)||void 0===o?void 0:o[e])||void 0===r?void 0:r.fullPath)||(un(e)?i.pathname+i.search+i.hash:null)}function tn(e,t){const n=lo.rawWindow.location;let o=t.pathname+t.search+t.hash,r=!1;if(sn(e)){let{pathname:t,search:i,hash:s}=n;const a=nn(i,s),c=Yt(o);if(s&&!i){r=!0,a.hashQuery?a.hashQuery[e]=c:a.hashQuery={[e]:c};const t=s.includes("?")?s.slice(0,s.indexOf("?")+1):s+"?";s=t+se(a.hashQuery)}else a.searchQuery?a.searchQuery[e]=c:a.searchQuery={[e]:c},i="?"+se(a.searchQuery);return{fullPath:t+i+s,isAttach2Hash:r}}return(an(e)||ln(e))&&(o=n.pathname+n.search+n.hash),{fullPath:o,isAttach2Hash:r}}function nn(e,t){const n={};return""!==e&&"?"!==e&&(n.searchQuery=ie(e.slice(1))),t.includes("?")&&(n.hashQuery=ie(t.slice(t.indexOf("?")+1))),n}function on(e){const t=zn.get(e);return!(!t||t.isPrefetch)}function rn(e){var t;return null===(t=zn.get(e))||void 0===t?void 0:t.routerMode}function sn(e){return rn(e)===$e}function an(e){return rn(e)===je}function cn(e){return rn(e)===Ke}function ln(e){return rn(e)===Ge}function un(e){return cn(e)||function(e){return rn(e)===qe}(e)}function pn(e,t){const n=t&&Ke||e||vo.options["disable-memory-router"]&&Ke||vo.options["router-mode"]||$e;return Qe.includes(n)?n:$e}function hn(e){const t=lo.rawWindow,n=t=>{var n,o,r;if(fo({excludeHiddenApp:!0,excludePreRender:!0}).includes(e)&&!t.onlyForBrowser&&(!un(e)||!lo.rawWindow.history.state||Gt(e))){const t=null===(n=zn.get(e))||void 0===n?void 0:n.container;!function(e,t=0,...n){setTimeout(e.bind(null,...n),t)}((()=>dn(e,en(e))),null!==(r=null===(o=t&&ne(t))||void 0===o?void 0:o.getRouterEventDelay())&&void 0!==r?r:0)}};return t.addEventListener("popstate",n),()=>{t.removeEventListener("popstate",n)}}function dn(e,t){const n=zn.get(e);if(null==n?void 0:n.sandBox){const o=n.sandBox.proxyWindow,r=n.sandBox.microAppWindow;let i=!1;const s=o.location.href;if(t){const n=o.location.hash;Cn(e,t,r.location),i=o.location.hash!==n}!function(e,t,n){const o=new PopStateEvent("popstate",{state:qt(e)});n.dispatchEvent(o),Yn(e)||_(t.onpopstate)&&t.onpopstate(o)}(e,o,r),i&&function(e,t,n,o){const r=new HashChangeEvent("hashchange",{newURL:t.location.href,oldURL:o});n.dispatchEvent(r),Yn(e)||_(t.onhashchange)&&t.onhashchange(r)}(e,o,r,s),J()}}function mn(e,t,n){J(),on(e)&&(function(e){const t=new PopStateEvent("popstate",{state:null});e&&(t.onlyForBrowser=!0),lo.rawWindow.dispatchEvent(t)}(t),n&&function(e){const t=new HashChangeEvent("hashchange",{newURL:lo.rawWindow.location.href,oldURL:e});lo.rawWindow.dispatchEvent(t)}(n))}function fn(e,t){const n=lo.rawWindow.history;function o(n){return function(...o){var r,i,s;o[2]=p(o[2])||h(o[2])||""+o[2]==""?t.href:""+o[2];const a=x(o[2],t.href),c=a.pathname+a.search+a.hash;ln(e)||wn(e,n,tn(e,a),!0,$t(e,o[0],a),o[1]),c!==t.fullPath&&Cn(e,c,t),null===(s=null===(r=zn.get(e))||void 0===r?void 0:(i=r.sandBox).updateIframeBase)||void 0===s||s.call(i)}}const r=o("pushState"),i=o("replaceState");return Yn(e)?{pushState:r,replaceState:i,go:e=>n.go(e)}:new Proxy(n,{get:(t,n)=>"state"===n?qt(e):"pushState"===n?r:"replaceState"===n?i:Tt(Reflect.get(t,n),t,"HISTORY"),set:(e,t,n)=>(Reflect.set(e,t,n),!0)})}function _n(e,t,n,o=null,r=""){if(on(e)){("pushState"===t?lo.rawPushState:lo.rawReplaceState).call(lo.rawWindow.history,o,r,n)}}function wn(e,t,n,o,r,i){if(on(e)){const s=lo.rawWindow.location,a=s.pathname+s.search+s.hash,c=n.isAttach2Hash&&a!==n.fullPath?s.href:null;_n(e,t,n.fullPath,r,i),a!==n.fullPath&&sn(e)&&mn(e,o,c)}}function gn(e,t,n){wn(e,"replaceState",t,!0,n)}function An(e){const t=lo.rawWindow;return function(...n){var o;if((null===(o=t.history.state)||void 0===o?void 0:o.__MICRO_APP_STATE__)&&(!w(n[0])||!n[0].__MICRO_APP_STATE__)&&(d(n[2])||y(n[2]))){const e=t.location.href;x(n[2],e).href===e&&(n[0]=i({},n[0],{__MICRO_APP_STATE__:t.history.state.__MICRO_APP_STATE__}))}e.apply(t.history,n),fo({excludeHiddenApp:!0,excludePreRender:!0}).forEach((e=>{if((sn(e)||an(e))&&!en(e)){const t=zn.get(e);gn(e,tn(e,t.sandBox.proxyWindow.location),$t(e,qt(e),t.sandBox.proxyWindow.location))}un(e)&&!Gt(e)&&_n(e,"replaceState",t.location.href,$t(e))})),J()}}function yn(){const e=lo.rawWindow;e.history.pushState=An(lo.rawPushState),e.history.replaceState=An(lo.rawReplaceState)}function bn(){const e=lo.rawWindow;e.history.pushState=lo.rawPushState,e.history.replaceState=lo.rawReplaceState}const{router:vn,executeNavigationGuard:En,clearRouterWhenUnmount:Pn}=function(){function e(e,t,n,o){const r=t.sandBox.proxyWindow.location,i=x(n.path,r.href),s=r.pathname+r.search+r.hash,a=i.pathname+i.search+i.hash;if(s!==a||en(e)!==a){if(!ln(e)){!function(e,t,n,o){wn(e,t,tn(e,n),!1,$t(e,null!=o?o:null,n)),J()}(e,o&&!1!==n.replace||!0===n.replace?"replaceState":"pushState",i,n.state)}sn(e)||dn(e,a)}}function t(t){return function(n){return new Promise(((o,r)=>{const i=W(n.name);if(i&&d(n.path))if(fo({excludeHiddenApp:!0,excludePreRender:!0}).includes(i)){const r=zn.get(i);o(r.sandBox.sandboxReady.then((()=>e(i,r,n,t))))}else r(O("导航失败，请确保子应用渲染后再调用此方法"));else r(O("navigation failed, name & path are required when use router."+(t?"replace":"push")))}))}}function n(e){return function(...t){return lo.rawWindow.history[e](...t)}}const r=ae(),i=ae();function s(e,t,n,o){J();for(const r of o)_(r)?r(t,n,e):w(r)&&_(r[e])&&r[e](t,n)}function a(e){if(sn(e)||an(e)){const t=zn.get(e);gn(e,tn(e,t.sandBox.proxyWindow.location),$t(e,qt(e),t.sandBox.proxyWindow.location))}}const c=Object.assign(Object.assign({current:new Map,encode:Yt,decode:Jt,push:t(!1),replace:t(!0),go:n("go"),back:n("back"),forward:n("forward"),beforeEach:r.add,afterEach:i.add,attachToURL:function(e){(e=W(e))&&fo().includes(e)&&a(e)},attachAllToURL:function({includeHiddenApp:e=!1,includePreRender:t=!1}){fo({excludeHiddenApp:!e,excludePreRender:!t}).forEach((e=>a(e)))}},function(){const e=function(){const e=new Map;return{add:function(t,n){return e.set(t,n),()=>!!e.has(t)&&e.delete(t)},get:t=>e.get(t),delete:t=>!!e.has(t)&&e.delete(t)}}();return{setDefaultPage:function(t){const n=W(t.name);return n&&t.path?e.add(n,t.path):o},removeDefaultPage:function(t){return!!(t=W(t))&&e.delete(t)},getDefaultPage:e.get}}()),function(){let e=null;return{setBaseAppRouter:function(t){var n;h(n=t)||"object"!=typeof n||(e=new Proxy(t,{get:(e,t)=>(J(),Tt(Reflect.get(e,t),e,"BASEROUTER")),set:(e,t,n)=>(Reflect.set(e,t,n),!0)}))},getBaseAppRouter:()=>e}}());return{router:c,executeNavigationGuard:function(e,t,n){c.current.set(e,t),s(e,t,n,r.list()),H((()=>{s(e,t,n,i.list())}))},clearRouterWhenUnmount:function(e){c.current.delete(e)}}}(),Rn=["href","pathname","search","hash","host","hostname","port","protocol","search","origin","fullPath"];function Sn(e,t,n,o,r,i){const a=lo.rawWindow.location,c=!!n,l=x(t);function u(){return c?n.location:l}function p(t,n){const o=x(t,w.href);if(o.origin===w.origin){const t=tn(e,o);if(!un(e)){if(n=ln(e)?"replaceState":n,o.pathname===w.pathname&&o.search===w.search){let r=null;return(o.hash!==w.hash||ln(e))&&(t.isAttach2Hash&&(r=a.href),ln(e)&&o.hash||_n(e,n,t.fullPath,sn(e)?null:$t(e,null,o))),void(o.hash?sn(e)?mn(e,!1,r):dn(e,o.pathname+o.search+o.hash):_())}return _n(e,n,t.fullPath,sn(e)?null:$t(e,null,o)),void _()}return t.fullPath}return t}function h(n,o){const r=x(n,t);r[o]===w[o]&&w.hash?mn(e,!1):(_n(e,r[o]===w[o]||ln(e)?"replaceState":"pushState",tn(e,r).fullPath,sn(e)?null:$t(e,null,r)),_())}const d=t=>function(n){if(on(e)){const e=p(n,"assign"===t?"pushState":"replaceState");e&&a[t](x(e,a.origin).href)}},m=d("assign"),f=d("replace"),_=e=>a.reload(e);s(u(),"fullPath",{enumerable:!0,configurable:!0,get:()=>w.pathname+w.search+w.hash});const w=new Proxy({},{get:(t,n)=>{const s=u();if("assign"===n)return m;if("replace"===n)return f;if("reload"===n)return _;if("self"===n)return s;if("fullPath"===n)return s.fullPath;if(rt.includes(n)){if(cn(e))return a[n];if(c)return o[n]}if("href"===n){if(cn(e))return s[n].replace(s.origin,a.origin);if(c)return s[n].replace(r,i)}return Tt(Reflect.get(s,n),s,"LOCATION")},set:(n,o,r)=>{if(on(e)){const n=u();if("href"===o){const e=p(r,"pushState");e&&(a.href=x(e,a.origin).href)}else if("pathname"===o)if(un(e))a.pathname=r;else{h(("/"+r).replace(/^\/+/,"/")+w.search+w.hash,"pathname")}else if("search"===o)if(un(e))a.search=r;else{h(w.pathname+("?"+r).replace(/^\?+/,"?")+w.hash,"search")}else if("hash"===o)if(un(e))a.hash=r;else{const n=w.pathname+w.search+("#"+r).replace(/^#+/,"#"),o=x(n,t);o.hash!==w.hash&&(ln(e)||wn(e,"pushState",tn(e,o),!1,$t(e,null,o)),sn(e)||dn(e,o.pathname+o.search+o.hash))}else Reflect.set(n,o,r)}return!0}});return w}function Mn(e,t){const n=i({name:e},t);for(const e of Rn)n[e]=t[e];return n}function Cn(e,t,n,o){var r;const i=Mn(e,n),s=x(t,n.href);if(Yn(e)){const t=zn.get(e).sandBox.microAppWindow;null===(r=t.rawReplaceState)||void 0===r||r.call(t.history,qt(e),"",s.href)}else{let e=s.href;n.self.origin!==s.origin&&(e=e.replace(s.origin,n.self.origin)),n.self.href=e}const a=lo.rawWindow.location;un(e)&&t!==a.pathname+a.search+a.hash&&"prevent"!==o&&_n(e,"replaceState",t,lo.rawWindow.history.state);const c=Mn(e,n);("auto"===o||i.fullPath!==c.fullPath&&"prevent"!==o)&&En(e,c,i)}function Nn(e,t,n){const o=en(e);o?(Cn(e,o,t,"auto"),ln(e)&&In(e)):On(e,t,n)}function On(e,t,n){n&&Cn(e,n,t,"prevent"),ln(e)||gn(e,tn(e,t),$t(e,null,t)),function(e,t){En(e,Mn(e,t),Mn(e,t))}(e,t)}function Dn(e,t,n,o){if(!o&&!un(e)){const{pathname:o,search:r,hash:i}=x(t);Cn(e,o+r+i,n,"prevent")}ln(e)||In(e),Pn(e)}function In(e){gn(e,function(e){var t,n,o,r;let{pathname:i,search:s,hash:a}=lo.rawWindow.location,c=!1;if(sn(e)){const i=nn(s,a);if(null===(t=i.hashQuery)||void 0===t?void 0:t[e]){c=!0,null===(n=i.hashQuery)||void 0===n||delete n[e];const t=se(i.hashQuery);a=a.slice(0,a.indexOf("?")+Number(Boolean(t)))+t}else if(null===(o=i.searchQuery)||void 0===o?void 0:o[e]){null===(r=i.searchQuery)||void 0===r||delete r[e];const t=se(i.searchQuery);s=t?"?"+t:""}}return{fullPath:i+s+a,isAttach2Hash:c}}(e),Kt(e,lo.rawWindow.history.state))}function xn(e,t){const n=p(t)?lo.rawWindow.fetch:t;return _(n)?function(t,o,...r){return(d(t)||y(t))&&(t=x(t,e).toString()),J(),n.call(lo.rawWindow,t,o,...r)}:n}function Ln(e,t){const n=p(t)?lo.rawWindow.XMLHttpRequest:t;return A(n)?class extends n{open(t,n,...o){(d(n)&&!/^f(ile|tp):\/\//.test(n)||y(n))&&(n=x(n,e).toString()),J(),super.open(t,n,...o)}}:n}const{createMicroEventSource:Tn,clearMicroEventSource:Wn}=function(){let e;return{createMicroEventSource:function(t,n,o){const r=p(o)?lo.rawWindow.EventSource:o;return A(r)?class extends r{constructor(o,r,...i){if((d(o)||y(o))&&(o=x(o,n).toString()),J(),super(o,r,...i),e){const n=e.get(t);n?n.add(this):e.set(t,new Set([this]))}else e=new Map([[t,new Set([this])]])}close(){var n;super.close(),null===(n=e.get(t))||void 0===n||n.delete(this)}}:r},clearMicroEventSource:function(t){const n=null==e?void 0:e.get(t);(null==n?void 0:n.size)&&(n.forEach((e=>{e.close()})),n.clear())}}}();class Un extends Wt{constructor(e,t){super(e,t),this.active=!1,this.microAppWindow=new Ut,this.patchWith((n=>{this.getSpecialProperties(e),this.patchRouter(e,t,this.microAppWindow),this.windowEffect=jt(e,this.microAppWindow,this),this.documentEffect=Ft(e,this.microAppWindow,this),this.setMappingPropertiesWithRawDescriptor(this.microAppWindow),this.initStaticGlobalKeys(e,t,this.microAppWindow),n()}))}start({umdMode:e,baseroute:t,defaultPage:n,disablePatchRequest:o}){this.active||(this.active=!0,this.initRouteState(n),this.removeHistoryListener=hn(this.microAppWindow.__MICRO_APP_NAME__),un(this.microAppWindow.__MICRO_APP_NAME__)&&(this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=t),e||this.initGlobalKeysWhenStart(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow,o),1==++lo.activeSandbox&&(io(),yn()),1==++Un.activeCount&&window.__MICRO_APP_ENVIRONMENT__&&(xt(),window.addEventListener("unmount",It,!1)),lo.rawWindow._babelPolyfill&&(lo.rawWindow._babelPolyfill=!1))}stop({umdMode:e,keepRouteState:t,destroy:n,clearData:o}){var r;this.active&&(this.recordAndReleaseEffect({umdMode:e,clearData:o,destroy:n},!e||n),this.clearRouteState(t),null===(r=this.removeHistoryListener)||void 0===r||r.call(this),e&&!n||(Wn(this.microAppWindow.__MICRO_APP_NAME__),this.injectedKeys.forEach((e=>{Reflect.deleteProperty(this.microAppWindow,e)})),this.injectedKeys.clear(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(lo.rawWindow,e)})),this.escapeKeys.clear(),this.clearHijackUmdHooks()),0==--lo.activeSandbox&&(ao(),bn()),--Un.activeCount,this.active=!1)}initStaticGlobalKeys(e,t,n){n.__MICRO_APP_ENVIRONMENT__=!0,n.__MICRO_APP_NAME__=e,n.__MICRO_APP_URL__=t,n.__MICRO_APP_PUBLIC_PATH__=U(t),n.__MICRO_APP_BASE_ROUTE__="",n.__MICRO_APP_WINDOW__=n,n.__MICRO_APP_PRE_RENDER__=!1,n.__MICRO_APP_UMD_MODE__=!1,n.__MICRO_APP_PROXY_WINDOW__=this.proxyWindow,n.__MICRO_APP_SANDBOX__=this,n.__MICRO_APP_SANDBOX_TYPE__="with",n.rawWindow=lo.rawWindow,n.rawDocument=lo.rawDocument,n.microApp=i(new Mt(e),{removeDomScope:J,pureCreateElement:Z,location:n.location,router:vn})}recordAndReleaseEffect(e,t=!1){t?this.resetEffectSnapshot():this.recordEffectSnapshot(),this.releaseGlobalEffect(e)}resetEffectSnapshot(){this.windowEffect.reset(),this.documentEffect.reset(),Ot(this.microAppWindow.microApp)}recordEffectSnapshot(){this.windowEffect.record(),this.documentEffect.record(),Ct(this.microAppWindow.microApp)}rebuildEffectSnapshot(){this.windowEffect.rebuild(),this.documentEffect.rebuild(),Nt(this.microAppWindow.microApp)}releaseGlobalEffect({umdMode:e=!1,clearData:t=!1,isPrerender:n=!1,keepAlive:o=!1,destroy:r=!1}){var i,s,a;this.windowEffect.release(!e&&!o&&!n||r),this.documentEffect.release(),null===(i=this.microAppWindow.microApp)||void 0===i||i.clearDataListener(),null===(s=this.microAppWindow.microApp)||void 0===s||s.clearGlobalDataListener(),t&&(vo.clearData(this.microAppWindow.__MICRO_APP_NAME__),null===(a=this.microAppWindow.microApp)||void 0===a||a.clearData())}getSpecialProperties(e){var t;w(vo.options.plugins)&&(this.commonActionForSpecialProperties(vo.options.plugins.global),this.commonActionForSpecialProperties(null===(t=vo.options.plugins.modules)||void 0===t?void 0:t[e]))}commonActionForSpecialProperties(e){if(r(e))for(const t of e)w(t)&&(r(t.scopeProperties)&&(this.scopeProperties=this.scopeProperties.concat(t.scopeProperties)),r(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties)))}setPreRenderState(e){this.microAppWindow.__MICRO_APP_PRE_RENDER__=e}markUmdMode(e){this.microAppWindow.__MICRO_APP_UMD_MODE__=e}patchWith(e){this.sandboxReady=new Promise((t=>e(t)))}setMappingPropertiesWithRawDescriptor(e){let t,n;const o=lo.rawWindow;o===o.parent?t=n=this.proxyWindow:(t=o.top,n=o.parent),a(e,{top:this.createDescriptorForMicroAppWindow("top",t),parent:this.createDescriptorForMicroAppWindow("parent",n)}),nt.forEach((t=>{s(e,t,this.createDescriptorForMicroAppWindow(t,this.proxyWindow))}))}createDescriptorForMicroAppWindow(e,t){const{configurable:n=!0,enumerable:o=!0,writable:r,set:i}=Object.getOwnPropertyDescriptor(lo.rawWindow,e)||{writable:!0};return{value:t,configurable:n,enumerable:o,writable:null!=r?r:!!i}}initGlobalKeysWhenStart(e,t,n,o){n.hasOwnProperty=e=>l.call(n,e)||l.call(lo.rawWindow,e),this.setHijackProperty(e,n),o||this.patchRequestApi(e,t,n),this.setScopeProperties(n)}setHijackProperty(e,t){let n,o;a(t,{eval:{configurable:!0,enumerable:!1,get:()=>(q(e),n||lo.rawWindow.eval),set:e=>{n=e}},Image:{configurable:!0,enumerable:!1,get:()=>(q(e),o||lo.ImageProxy),set:e=>{o=e}}})}patchRequestApi(e,t,n){let o=xn(t),r=Ln(t),i=Tn(e,t);a(n,{fetch:{configurable:!0,enumerable:!0,get:()=>o,set(e){o=xn(t,e)}},XMLHttpRequest:{configurable:!0,enumerable:!0,get:()=>r,set(e){r=Ln(t,e)}},EventSource:{configurable:!0,enumerable:!0,get:()=>i,set(n){i=Tn(e,t,n)}}})}setScopeProperties(e){this.scopeProperties.forEach((t=>{Reflect.set(e,t,e[t])}))}patchRouter(e,t,n){const{microLocation:o,microHistory:r}=function(e,t){const n=Sn(e,t);return{microLocation:n,microHistory:fn(e,n)}}(e,t);a(n,{location:{configurable:!1,enumerable:!0,get:()=>o,set:e=>{lo.rawWindow.location=e}},history:{configurable:!0,enumerable:!0,get:()=>r}})}initRouteState(e){Nn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location,e)}clearRouteState(e){Dn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow.location,e)}setRouteInfoForKeepAliveApp(){On(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location)}removeRouteInfoForKeepAliveApp(){In(this.microAppWindow.__MICRO_APP_NAME__)}patchStaticElement(e){Bt(e,this.microAppWindow.__MICRO_APP_NAME__)}actionsBeforeExecScripts(e,t){this.patchStaticElement(e),this.clearHijackUmdHooks=this.hijackUmdHooks(this.appName,this.microAppWindow,t)}hijackUmdHooks(e,t,n){let o,r,i;return a(t,{mount:{configurable:!0,get:()=>o,set:e=>{this.active&&_(e)&&!o&&n(o=e,r)}},unmount:{configurable:!0,get:()=>r,set:e=>{this.active&&_(e)&&!r&&n(o,r=e)}},[`micro-app-${e}`]:{configurable:!0,get:()=>i,set:e=>{this.active&&w(e)&&!i&&(i=e,n(i.mount,i.unmount))}}}),()=>{o=r=i=null}}setStaticAppState(e){this.microAppWindow.__MICRO_APP_STATE__=e}}Un.activeCount=0;const Bn=["getComputedStyle","DOMParser","visualViewport","matchMedia","ResizeObserver","IntersectionObserver"],kn=[/animationFrame$/i,/mutationObserver$/i,/height$|width$/i,/offset$/i,/selection$/i,/^range/i,/^screen/i,/^scroll/i,/X$|Y$/],Hn=["body","head","html","title"],Fn=["childElementCount","children","firstElementChild","firstChild","lastElementChild","activeElement","fullscreenElement","pictureInPictureElement","pointerLockElement","styleSheets"],jn=["append","contains","replaceChildren","createRange","getSelection","elementFromPoint","elementsFromPoint","getAnimations"],$n=["characterSet","compatMode","contentType","designMode","dir","doctype","embeds","fullscreenEnabled","hidden","implementation","lastModified","pictureInPictureEnabled","plugins","readyState","referrer","visibilityState","fonts"],Kn=["execCommand","createRange","exitFullscreen","exitPictureInPicture","getElementsByTagNameNS","hasFocus","prepend"];function qn(e,t,n){return function(e,t){const n=lo.rawWindow;Bn.forEach((e=>{t[e]=Tt(n[e],n)})),Object.getOwnPropertyNames(t).filter((e=>(kn.some((o=>{if(o.test(e)&&e in t.parent){if(_(n[e]))t[e]=Tt(n[e],n);else{const{configurable:o,enumerable:r}=Object.getOwnPropertyDescriptor(t,e)||{configurable:!0,enumerable:!0};o&&s(t,e,{configurable:o,enumerable:r,get:()=>n[e],set:t=>{n[e]=t}})}return!0}return!1})),A(t[e])&&e in n&&s(t[e],Symbol.hasInstance,{configurable:!0,enumerable:!1,value:o=>o instanceof n[e]||function(e,t){if(null==e)return!1;if(!_(t))throw new TypeError("Right-hand side of 'instanceof' is not callable");let n=Object.getPrototypeOf(e);for(;n;){if(n===t.prototype)return!0;n=Object.getPrototypeOf(n)}return!1}(o,t[e])}),/^on/.test(e)&&!Ze.includes(e)))).forEach((o=>{const{enumerable:r,writable:i,set:a}=Object.getOwnPropertyDescriptor(t,o)||{enumerable:!0,writable:!0};try{s(t,o,{enumerable:r,configurable:!0,get:()=>n[o],set:(null!=i?i:a)?e=>{n[o]=_(e)?e.bind(t):e}:void 0})}catch(t){D(t,e)}}))}(e,t),function(e,t){const n=lo.rawWindow,o=new Set,r=new Proxy(e,{get:(e,i)=>"location"===i?t.proxyLocation:N(nt,i)?r:o.has(i)?Reflect.get(e,i):N(t.escapeProperties,i)&&!Reflect.has(e,i)?Tt(Reflect.get(n,i),n):Tt(Reflect.get(e,i),e),set:(e,r,i)=>"location"===r?Reflect.set(n,r,i):(Reflect.has(e,r)||o.add(r),Reflect.set(e,r,i),N(t.escapeProperties,r)&&(!Reflect.has(n,r)&&t.escapeKeys.add(r),Reflect.set(n,r,i)),!0),has:(e,t)=>t in e,deleteProperty:(e,o)=>!Reflect.has(e,o)||(t.escapeKeys.has(o)&&Reflect.deleteProperty(n,o),Reflect.deleteProperty(e,o))});t.proxyWindow=r}(t,n),function(e){const{rawWindow:t,rawAddEventListener:n,rawRemoveEventListener:o,rawDispatchEvent:r}=lo,i=new Map,s=new Map;function a(n){return Ve.includes(n)?e:t}e.addEventListener=function(e,t,o){const r=i.get(e);r?r.add(t):i.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=o),n.call(a(e),e,t,o)},e.removeEventListener=function(e,t,n){const r=i.get(e);(null==r?void 0:r.size)&&r.has(t)&&r.delete(t),o.call(a(e),e,t,n)},e.dispatchEvent=function(e){return r.call(a(null==e?void 0:e.type),e)};const c=()=>{s.clear()},l=()=>{s.forEach(((t,n)=>{for(const o of t)e.addEventListener(n,o,null==o?void 0:o.__MICRO_APP_MARK_OPTIONS__)})),c()};return{reset:c,record:()=>{i.forEach(((e,t)=>{if(e.size){const n=s.get(t)||[];s.set(t,new Set([...n,...e]))}}))},rebuild:l,release:()=>{i.size&&(i.forEach(((e,t)=>{for(const n of e)o.call(a(t),t,n)})),i.clear())}}}(t)}function Gn(e,t,n){return function(e,t){const n=lo.rawDocument,o=t.Document,r=t.document,i=o.prototype.createElement,s=o.prototype.createElementNS,a=o.prototype.createTextNode,c=o.prototype.createDocumentFragment,l=o.prototype.createComment,u=o.prototype.querySelector,p=o.prototype.querySelectorAll,h=o.prototype.getElementById,d=o.prototype.getElementsByClassName,m=o.prototype.getElementsByTagName,f=o.prototype.getElementsByName,_=o.prototype.elementFromPoint,w=o.prototype.caretRangeFromPoint;function g(t){return z(e),r===t?n:t}function A(t){var o,i,s;const a=g(this);return!t||te(t)||n!==a?u.call(a,t):null!==(s=null!==(i=null===(o=zn.get(e))||void 0===o?void 0:o.querySelector(t))&&void 0!==i?i:u.call(r,t))&&void 0!==s?s:null}function y(t){var o,i;const s=g(this);if(!t||te(t)||n!==s)return p.call(s,t);const a=null!==(i=null===(o=zn.get(e))||void 0===o?void 0:o.querySelectorAll(t))&&void 0!==i?i:[];return a.length?a:p.call(r,t)}o.prototype.caretRangeFromPoint=function(t,o){const r=_.call(n,t,o),i=w.call(n,t,o);return kt(r,e),i},o.prototype.createElement=function(t,n){return kt(i.call(this,t,n),e)},o.prototype.createElementNS=function(t,n,o){return kt(s.call(this,t,n,o),e)},o.prototype.createTextNode=function(t){return kt(a.call(this,t),e)},o.prototype.createDocumentFragment=function(){return kt(c.call(this),e)},o.prototype.createComment=function(t){return kt(l.call(this,t),e)},o.prototype.querySelector=A,o.prototype.querySelectorAll=y,o.prototype.getElementById=function(e){const t=g(this);if(ee(e))return h.call(t,e);try{return A.call(this,`#${e}`)}catch(n){return h.call(t,e)}},o.prototype.getElementsByClassName=function(e){const t=g(this);if(ee(e))return d.call(t,e);try{return y.call(this,`.${e}`)}catch(n){return d.call(t,e)}},o.prototype.getElementsByTagName=function(e){const t=g(this);if(te(e)||ee(e))return m.call(t,e);if(/^script|base$/i.test(e))return m.call(r,e);try{return y.call(this,e)}catch(n){return m.call(t,e)}},o.prototype.getElementsByName=function(e){const t=g(this);if(ee(e))return f.call(t,e);try{return y.call(this,`[name=${e}]`)}catch(n){return f.call(t,e)}}}(e,t),function(e,t,n){const o=lo.rawDocument,r=t.Document,i=t.document,c=(e,t)=>{const{enumerable:n}=Object.getOwnPropertyDescriptor(r.prototype,e)||{enumerable:!0};return{configurable:!0,enumerable:n,get:t}},l=()=>{const t={};return[["documentURI",()=>n.proxyLocation.href],["URL",()=>n.proxyLocation.href],["documentElement",()=>o.documentElement],["scrollingElement",()=>o.scrollingElement],["forms",()=>r.prototype.querySelectorAll.call(i,"form")],["images",()=>r.prototype.querySelectorAll.call(i,"img")],["links",()=>r.prototype.querySelectorAll.call(i,"a")],["microAppElement",()=>{var t;return null===(t=zn.get(e))||void 0===t?void 0:t.container}],["__MICRO_APP_NAME__",()=>e]].forEach((e=>{t[e[0]]=c(e[0],e[1])})),Fn.forEach((e=>{t[e]=c(e,(()=>o[e]))})),jn.forEach((e=>{t[e]=c(e,(()=>Tt(o[e],o,"DOCUMENT")))})),$n.forEach((e=>{t[e]=c(e,(()=>o[e]))})),Kn.forEach((e=>{t[e]=c(e,(()=>Tt(o[e],o,"DOCUMENT")))})),t};a(r.prototype,l()),Hn.forEach((t=>{s(i,t,{enumerable:!0,configurable:!0,get:()=>(z(e),o[t]),set:e=>{o[t]=e}})}))}(e,t,n),function(e,t){const{rawDocument:n,rawAddEventListener:o,rawRemoveEventListener:r,rawDispatchEvent:i}=lo,a=new Map,c=new Map;let l=null,u=null;const p=t.Document,h=t.document;function d(e,t){return et.includes(e)?t:n}function m(e){return"onclick"===e?e=>{_(l)&&r.call(n,"click",l,!1),_(e)?(l=e.bind(h),o.call(n,"click",l,!1)):l=e}:t=>{n[e]=_(t)?t.bind(h):t}}p.prototype.addEventListener=function(e,t,n){const r=_(t)?t.__MICRO_APP_BOUND_FUNCTION__=t.__MICRO_APP_BOUND_FUNCTION__||t.bind(this):t,i=a.get(e);i?i.add(t):a.set(e,new Set([t])),t&&(t.__MICRO_APP_MARK_OPTIONS__=n),o.call(d(e,this),e,r,n)},p.prototype.removeEventListener=function(e,t,n){const o=a.get(e);(null==o?void 0:o.size)&&o.has(t)&&o.delete(t);const i=(null==t?void 0:t.__MICRO_APP_BOUND_FUNCTION__)||t;r.call(d(e,this),e,i,n)},p.prototype.dispatchEvent=function(e){return i.call(d(null==e?void 0:e.type,this),e)},Object.getOwnPropertyNames(p.prototype).filter((e=>/^on/.test(e)&&!tt.includes(e))).forEach((t=>{const{enumerable:o,writable:r,set:i}=Object.getOwnPropertyDescriptor(p.prototype,t)||{enumerable:!0,writable:!0};try{s(p.prototype,t,{enumerable:o,configurable:!0,get:()=>"onclick"===t?l:n[t],set:(null!=r?r:i)?m(t):void 0})}catch(t){D(t,e)}}));const f=()=>{c.clear(),u=null},w=()=>{u&&!l&&(h.onclick=u),c.forEach(((e,t)=>{for(const n of e)h.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),f()};return{reset:f,record:()=>{u=l||u,a.forEach(((e,t)=>{if(e.size){const n=c.get(t)||[];c.set(t,new Set([...n,...e]))}}))},rebuild:w,release:()=>{_(l)&&r.call(n,"click",l),l=null,a.size&&(a.forEach(((e,t)=>{for(const n of e)r.call(d(t,h),t,(null==n?void 0:n.__MICRO_APP_BOUND_FUNCTION__)||n)})),a.clear())}}}(e,t)}function Qn(e,t,n,o){!function(e,t,n){const o=lo.rawRootElement,r=lo.rawRootNode,i=lo.rawDocument,a=t.document,c=t.Node,l=t.Element,p=t.DocumentFragment,h=c.prototype.appendChild,d=c.prototype.insertBefore,m=c.prototype.replaceChild,f=c.prototype.removeChild,_=l.prototype.append,w=l.prototype.prepend,g=p.prototype.append,A=p.prototype.prepend,y=l.prototype.insertAdjacentElement,E=c.prototype.cloneNode,P=Object.getOwnPropertyDescriptor(l.prototype,"innerHTML"),M=Object.getOwnPropertyDescriptor(c.prototype,"parentNode"),C=Object.getOwnPropertyDescriptor(c.prototype,"ownerDocument"),N=e=>(R(e)||function(e){return"[object HTMLBaseElement]"===u(e)}(e))&&e.__PURE_ELEMENT__,O=e=>e===n.microHead?i.head:e===n.microBody?i.body:e;c.prototype.appendChild=function(t){return kt(t,e),N(t)?h.call(this,t):r.prototype.appendChild.call(O(this),t)},c.prototype.insertBefore=function(t,n){return kt(t,e),N(t)?d.call(this,t,n):r.prototype.insertBefore.call(O(this),t,n)},c.prototype.replaceChild=function(t,n){return kt(t,e),N(t)?m.call(this,t,n):r.prototype.replaceChild.call(O(this),t,n)},c.prototype.removeChild=function(e){return N(e)||this.contains(e)?f.call(this,e):r.prototype.removeChild.call(O(this),e)},p.prototype.append=l.prototype.append=function(...e){let t=0,n=!1;for(;t<e.length;)e[t]=v(e[t])?e[t]:a.createTextNode(e[t]),N(e[t])&&(n=!0),t++;return n?(S(this)?g:_).call(this,...e):o.prototype.append.call(O(this),...e)},p.prototype.prepend=l.prototype.prepend=function(...e){let t=0,n=!1;for(;t<e.length;)e[t]=v(e[t])?e[t]:a.createTextNode(e[t]),N(e[t])&&(n=!0),t++;return n?(S(this)?A:w).call(this,...e):o.prototype.prepend.call(O(this),...e)},l.prototype.insertAdjacentElement=function(t,n){return kt(n,e),N(n)?y.call(this,t,n):o.prototype.insertAdjacentElement.call(O(this),t,n)},s(c.prototype,"baseURI",{configurable:!0,enumerable:!0,get:()=>n.proxyWindow.location.href}),s(c.prototype,"ownerDocument",{configurable:!0,enumerable:!0,get(){var e;return this.__PURE_ELEMENT__||this===a?null===(e=C.get)||void 0===e?void 0:e.call(this):a}}),s(c.prototype,"parentNode",Ht(e,M)),c.prototype.getRootNode=function(){return a},c.prototype.cloneNode=function(t){return kt(E.call(this,t),e)},s(l.prototype,"innerHTML",{configurable:!0,enumerable:!0,get(){var e;return null===(e=P.get)||void 0===e?void 0:e.call(this)},set(t){var n;null===(n=P.set)||void 0===n||n.call(this,t),Array.from(this.children).forEach((t=>{b(t)&&kt(t,e)}))}});const D=new Proxy(t.Image,{construct(t,n){const o=new t(...n);return kt(o,e),o}});s(t,"Image",{configurable:!0,writable:!0,value:D})}(e,n,o),function(e,t){const n=t.Element,o=n.prototype.setAttribute;n.prototype.setAttribute=function(t,r){/^micro-app(-\S+)?/i.test(this.tagName)&&"data"===t&&this.setAttribute!==n.prototype.setAttribute?this.setAttribute(t,r):((("src"===t||"srcset"===t)&&/^(img|script|video|audio|source|embed)$/i.test(this.tagName)||"href"===t&&/^(link|image)$/i.test(this.tagName))&&(r=B(r,e)),o.call(this,t,r))};const r=[[t.HTMLImageElement.prototype,"src"],[t.HTMLScriptElement.prototype,"src"],[t.HTMLLinkElement.prototype,"href"],[t.SVGImageElement.prototype,"href"]];r.forEach((([t,n])=>{const{enumerable:o,configurable:r,get:i,set:a}=Object.getOwnPropertyDescriptor(t,n)||{enumerable:!0,configurable:!0};s(t,n,{enumerable:o,configurable:r,get:function(){return null==i?void 0:i.call(this)},set:function(t){null==a||a.call(this,B(t,e))}})}))}(t,n)}class Xn{constructor(e,t){this.active=!1,this.escapeProperties=[],this.escapeKeys=new Set,this.updateIframeBase=()=>{var e;null===(e=this.baseElement)||void 0===e||e.setAttribute("href",x(this.url).origin+this.proxyLocation.pathname)},this.appName=e,this.url=t;const n=lo.rawWindow.location,o=n.protocol+"//"+n.host;this.deleteIframeElement=this.createIframeElement(e,o+n.pathname),this.microAppWindow=this.iframe.contentWindow,this.patchIframe(this.microAppWindow,(n=>{this.createIframeTemplate(this.microAppWindow),this.getSpecialProperties(e),this.proxyLocation=function(e,t,n,o){const r=lo.rawWindow.history,s=x(t),c=s.protocol+"//"+s.host,l=s.pathname+s.search+s.hash,u=n.history;return n.rawReplaceState=u.replaceState,i(u,fn(e,n.location)),a(u,{scrollRestoration:{configurable:!0,enumerable:!0,get:()=>r.scrollRestoration,set(e){r.scrollRestoration=e}}}),Cn(e,l,n.location,"prevent"),Sn(e,t,n,s,o,c)}(e,t,this.microAppWindow,o),this.windowEffect=qn(e,this.microAppWindow,this),this.documentEffect=Gn(e,this.microAppWindow,this),Qn(e,t,this.microAppWindow,this),this.initStaticGlobalKeys(e,t,this.microAppWindow),n()}))}createIframeElement(e,t){this.iframe=Z("iframe");const n={id:e,src:vo.options.iframeSrc||t,style:"display: none","powered-by":"micro-app"};return Object.keys(n).forEach((e=>this.iframe.setAttribute(e,n[e]))),lo.rawDocument.body.appendChild(this.iframe),()=>I((()=>{var e,t;null===(t=null===(e=this.iframe)||void 0===e?void 0:e.parentNode)||void 0===t||t.removeChild(this.iframe),this.iframe=null}))}start({baseroute:e,defaultPage:t,disablePatchRequest:n}){this.active||(this.active=!0,this.initRouteState(t),this.removeHistoryListener=hn(this.microAppWindow.__MICRO_APP_NAME__),un(this.microAppWindow.__MICRO_APP_NAME__)&&(this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=e),n||this.createIframeBase(),1==++lo.activeSandbox&&(io(),yn()),++Xn.activeCount)}stop({umdMode:e,keepRouteState:t,destroy:n,clearData:o}){var r;this.active&&(this.recordAndReleaseEffect({clearData:o},!e||n),this.clearRouteState(t),null===(r=this.removeHistoryListener)||void 0===r||r.call(this),e&&!n||(this.deleteIframeElement(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(lo.rawWindow,e)})),this.escapeKeys.clear(),this.clearHijackUmdHooks()),0==--lo.activeSandbox&&(ao(),bn()),--Xn.activeCount,this.active=!1)}initStaticGlobalKeys(e,t,n){n.__MICRO_APP_ENVIRONMENT__=!0,n.__MICRO_APP_NAME__=e,n.__MICRO_APP_URL__=t,n.__MICRO_APP_PUBLIC_PATH__=U(t),n.__MICRO_APP_BASE_ROUTE__="",n.__MICRO_APP_WINDOW__=n,n.__MICRO_APP_PRE_RENDER__=!1,n.__MICRO_APP_UMD_MODE__=!1,n.__MICRO_APP_PROXY_WINDOW__=this.proxyWindow,n.__MICRO_APP_SANDBOX__=this,n.__MICRO_APP_SANDBOX_TYPE__="iframe",n.rawWindow=lo.rawWindow,n.rawDocument=lo.rawDocument,n.microApp=i(new Mt(e),{removeDomScope:J,pureCreateElement:Z,location:this.proxyLocation,router:vn})}recordAndReleaseEffect(e,t=!1){t?this.resetEffectSnapshot():this.recordEffectSnapshot(),this.releaseGlobalEffect(e)}resetEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.reset(),null===(t=this.documentEffect)||void 0===t||t.reset(),Ot(this.microAppWindow.microApp)}recordEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.record(),null===(t=this.documentEffect)||void 0===t||t.record(),Ct(this.microAppWindow.microApp)}rebuildEffectSnapshot(){var e,t;null===(e=this.windowEffect)||void 0===e||e.rebuild(),null===(t=this.documentEffect)||void 0===t||t.rebuild(),Nt(this.microAppWindow.microApp)}releaseGlobalEffect({clearData:e=!1}){var t,n,o,r,i;null===(t=this.windowEffect)||void 0===t||t.release(),null===(n=this.documentEffect)||void 0===n||n.release(),null===(o=this.microAppWindow.microApp)||void 0===o||o.clearDataListener(),null===(r=this.microAppWindow.microApp)||void 0===r||r.clearGlobalDataListener(),e&&(vo.clearData(this.microAppWindow.__MICRO_APP_NAME__),null===(i=this.microAppWindow.microApp)||void 0===i||i.clearData())}setPreRenderState(e){this.microAppWindow.__MICRO_APP_PRE_RENDER__=e}markUmdMode(e){this.microAppWindow.__MICRO_APP_UMD_MODE__=e}patchIframe(e,t){const n=e.document;this.sandboxReady=new Promise((o=>{!function r(){setTimeout((()=>{try{e.document===n?r():(e.stop(),t(o))}catch(e){r()}}),0)}()}))}createIframeTemplate(e){const t=e.document;!function(e){for(;null==e?void 0:e.firstChild;)e.removeChild(e.firstChild)}(t);const n=t.createElement("html");n.innerHTML="<head></head><body></body>",t.appendChild(n),this.microBody=t.body,this.microHead=t.head}createIframeBase(){this.baseElement=Z("base"),this.updateIframeBase(),this.microHead.appendChild(this.baseElement)}getSpecialProperties(e){var t;w(vo.options.plugins)&&(this.commonActionForSpecialProperties(vo.options.plugins.global),this.commonActionForSpecialProperties(null===(t=vo.options.plugins.modules)||void 0===t?void 0:t[e]))}commonActionForSpecialProperties(e){if(r(e))for(const t of e)w(t)&&r(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties))}initRouteState(e){Nn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location,e)}clearRouteState(e){Dn(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.__MICRO_APP_URL__,this.microAppWindow.location,e)}setRouteInfoForKeepAliveApp(){On(this.microAppWindow.__MICRO_APP_NAME__,this.microAppWindow.location)}removeRouteInfoForKeepAliveApp(){In(this.microAppWindow.__MICRO_APP_NAME__)}patchStaticElement(e){Bt(e,this.microAppWindow.__MICRO_APP_NAME__)}actionsBeforeExecScripts(e,t){this.patchStaticElement(e),this.clearHijackUmdHooks=this.hijackUmdHooks(this.appName,this.microAppWindow,t)}hijackUmdHooks(e,t,n){let o,r,i;return a(t,{mount:{configurable:!0,get:()=>o,set:e=>{this.active&&_(e)&&!o&&n(o=e,r)}},unmount:{configurable:!0,get:()=>r,set:e=>{this.active&&_(e)&&!r&&n(o,r=e)}},[`micro-app-${e}`]:{configurable:!0,get:()=>i,set:e=>{this.active&&w(e)&&!i&&(i=e,n(i.mount,i.unmount))}}}),()=>{o=r=i=null}}setStaticAppState(e){this.microAppWindow.__MICRO_APP_STATE__=e}}Xn.activeCount=0;const zn=new Map;class Vn{constructor({name:e,url:t,container:n,scopecss:o,useSandbox:r,inline:i,iframe:s,ssrUrl:a,isPrefetch:c,prefetchLevel:l,routerMode:u}){this.state=De.CREATED,this.keepAliveState=null,this.loadSourceLevel=0,this.umdHookMount=null,this.umdHookUnmount=null,this.umdMode=!1,this.sandBox=null,this.fiber=!1,zn.set(e,this),this.name=e,this.url=t,this.useSandbox=r,this.scopecss=this.useSandbox&&o,this.iframe=null!=s&&s,this.inline=this.getInlineModeState(i),this.routerMode=u||$e,this.container=null!=n?n:null,this.ssrUrl=null!=a?a:"",this.isPrefetch=null!=c&&c,this.isPrerender=3===l,this.prefetchLevel=l,this.source={html:null,links:new Set,scripts:new Set},this.loadSourceCode(),this.createSandbox()}loadSourceCode(){this.setAppState(De.LOADING),ge.getInstance().run(this,vt)}onLoad({html:e,defaultPage:t,routerMode:n,baseroute:o,disablePatchRequest:r}){var i;if(2==++this.loadSourceLevel){if(this.source.html=e,this.isUnmounted())return;if(this.isPrefetch){if(this.isPrerender){const e=Z("div");e.setAttribute("prerender","true"),null===(i=this.sandBox)||void 0===i||i.setPreRenderState(!0),this.mount({container:e,inline:this.inline,fiber:!0,defaultPage:t||"",disablePatchRequest:null!=r&&r,routerMode:n,baseroute:o||""})}}else ne(this.container).mount(this)}}onLoadError(e){this.loadSourceLevel=-1,this.isUnmounted()||(this.onerror(e),this.setAppState(De.LOAD_FAILED))}mount({container:e,inline:t,routerMode:n,defaultPage:o,baseroute:r,disablePatchRequest:i,fiber:s}){if(2!==this.loadSourceLevel)return this.container=e,this.isPrerender=!1,_e(this,"statechange",{appState:De.LOADING}),this.setAppState(De.LOADING);this.createSandbox(),this.setAppState(De.BEFORE_MOUNT);const a=()=>{var a,c,l,h,m,f,w,g;if(this.isPrerender&&(g=this.container,"[object HTMLDivElement]"===u(g))&&this.container.hasAttribute("prerender"))this.container=this.cloneContainer(e,this.container,!1),null===(a=this.sandBox)||void 0===a||a.rebuildEffectSnapshot(),null===(c=this.preRenderEvents)||void 0===c||c.forEach((e=>e())),this.isPrerender=!1,this.preRenderEvents=null,vn.attachToURL(this.name),null===(l=this.sandBox)||void 0===l||l.setPreRenderState(!1);else{this.container=e,this.inline=this.getInlineModeState(t),this.fiber=s,this.routerMode=n;const a=()=>{fe(this.container,this.name,Ie.BEFOREMOUNT)};if(this.isPrerender?(null!==(h=this.preRenderEvents)&&void 0!==h?h:this.preRenderEvents=[]).push(a):a(),this.setAppState(De.MOUNTING),_e(this,"statechange",{appState:De.MOUNTING}),this.cloneContainer(this.container,this.source.html,!this.umdMode),null===(m=this.sandBox)||void 0===m||m.start({umdMode:this.umdMode,baseroute:r,defaultPage:o,disablePatchRequest:i}),this.umdMode){null===(w=this.sandBox)||void 0===w||w.rebuildEffectSnapshot();try{this.handleMounted(this.umdHookMount(vo.getData(this.name,!0)))}catch(e){O("An error occurred when mount \n",this.name,e)}}else null===(f=this.sandBox)||void 0===f||f.actionsBeforeExecScripts(this.container,((e,t)=>{var n;if(!this.umdMode&&!this.isUnmounted()&&(this.umdHookMount=_(e)?e:null,this.umdHookUnmount=_(t)?t:null,_(this.umdHookMount)&&_(this.umdHookUnmount))){null===(n=this.sandBox)||void 0===n||n.markUmdMode(this.umdMode=!0);try{this.getAppState()===De.MOUNTED?this.umdHookMount(vo.getData(this.name,!0)):this.handleMounted(this.umdHookMount(vo.getData(this.name,!0)))}catch(e){O("An error occurred when mount \n",this.name,e)}}})),function(e,t){const n=e.fiber?[]:null,o=Array.from(e.source.scripts),r=[],i=[];for(const s of o){const o=We.script.getInfo(s),a=o.appSpace[e.name];a.defer||a.async?(!o.isExternal||o.code||st(e,o)?r.push(o.code):r.push(we(s,e.name)),i.push([s,o]),st(e,o)&&(t.moduleCount=t.moduleCount?++t.moduleCount:1)):le(n,(()=>{gt(s,e,o),t(!1)}))}r.length?k(r,(e=>{const t=i[e.index][1];t.code=t.code||e.data}),(n=>{t.errorCount=t.errorCount?++t.errorCount:1,O(n,e.name)}),(()=>{i.forEach((([o,r])=>{d(r.code)&&le(n,(()=>{gt(o,e,r,t),!st(e,r)&&t(!1)}))})),n?(n.push((()=>Promise.resolve(t(p(t.moduleCount)||t.errorCount===r.length)))),ue(n)):t(p(t.moduleCount)||t.errorCount===r.length)})):n?(n.push((()=>Promise.resolve(t(!0)))),ue(n)):t(!0)}(this,(e=>{this.umdMode||!0!==e||this.handleMounted()}))}};this.sandBox?this.sandBox.sandboxReady.then((()=>!this.isUnmounted()&&a())):a()}handleMounted(e){var t,n;const o=()=>{const t=()=>this.actionsAfterMounted();g(e)?e.then(t).catch((e=>{O("An error occurred in window.mount \n",this.name,e),t()})):t()};this.isPrerender?(null===(t=this.preRenderEvents)||void 0===t||t.push(o),null===(n=this.sandBox)||void 0===n||n.recordAndReleaseEffect({isPrerender:!0})):o()}actionsAfterMounted(){var e;this.isUnmounted()||(this.setAppState(De.MOUNTED),he(this.getMicroAppGlobalHook(xe.ONMOUNT),this.name,xe.ONMOUNT,vo.getData(this.name,!0)),_e(this,"statechange",{appState:De.MOUNTED}),_e(this,"mounted"),fe(this.container,this.name,Ie.MOUNTED),this.isHidden()&&(null===(e=this.sandBox)||void 0===e||e.recordAndReleaseEffect({keepAlive:!0})))}unmount({destroy:e,clearData:t,keepRouteState:n,unmountcb:o}){var r;e=e||this.state===De.LOAD_FAILED,this.setAppState(De.UNMOUNT);try{this.handleUnmounted(e,t,n,o,null===(r=this.umdHookUnmount)||void 0===r?void 0:r.call(this,vo.getData(this.name,!0)))}catch(e){O("An error occurred when unmount \n",this.name,e)}}handleUnmounted(e,t,n,o,r){_e(this,"statechange",{appState:De.UNMOUNT}),_e(this,"unmount"),he(this.getMicroAppGlobalHook(xe.ONUNMOUNT),this.name,xe.ONUNMOUNT);const i=()=>this.actionsAfterUnmounted({destroy:e,clearData:t,keepRouteState:n,unmountcb:o});g(r)?(J(),r.then(i).catch((e=>{O("An error occurred in window.unmount \n",this.name,e),i()}))):i()}actionsAfterUnmounted({destroy:e,clearData:t,keepRouteState:n,unmountcb:o}){var r;this.umdMode&&this.container&&!e&&this.cloneContainer(this.source.html,this.container,!1),null===(r=this.sandBox)||void 0===r||r.stop({umdMode:this.umdMode,keepRouteState:n&&!e,destroy:e,clearData:t||e}),fe(this.container,this.name,Ie.UNMOUNT),this.clearOptions(e),null==o||o()}clearOptions(e){var t,n;this.isPrerender=!1,this.preRenderEvents=null,this.setKeepAliveState(null),this.container?(this.container.innerHTML="",this.container=null):this.umdMode||null===(n=null===(t=this.sandBox)||void 0===t?void 0:t.deleteIframeElement)||void 0===n||n.call(t),this.iframe&&!this.umdMode&&(this.sandBox=null),e&&this.actionsForCompletelyDestroy(),J()}actionsForCompletelyDestroy(){var e,t;null===(t=null===(e=this.sandBox)||void 0===e?void 0:e.deleteIframeElement)||void 0===t||t.call(e),We.script.deleteInlineInfo(this.source.scripts),zn.delete(this.name)}hiddenKeepAliveApp(e){var t,n;this.setKeepAliveState(Le.KEEP_ALIVE_HIDDEN),_e(this,"appstate-change",{appState:"afterhidden"}),fe(this.container,this.name,Ie.AFTERHIDDEN),sn(this.name)&&(null===(t=this.sandBox)||void 0===t||t.removeRouteInfoForKeepAliveApp()),2!==this.loadSourceLevel?ne(this.container).unmount():(this.container=this.cloneContainer(Z("div"),this.container,!1),null===(n=this.sandBox)||void 0===n||n.recordAndReleaseEffect({keepAlive:!0})),null==e||e()}showKeepAliveApp(e){var t,n;const o=this.container;this.container=e,null===(t=this.sandBox)||void 0===t||t.rebuildEffectSnapshot(),_e(this,"appstate-change",{appState:"beforeshow"}),fe(e,this.name,Ie.BEFORESHOW),this.setKeepAliveState(Le.KEEP_ALIVE_SHOW),this.cloneContainer(this.container,o,!1),sn(this.name)&&(null===(n=this.sandBox)||void 0===n||n.setRouteInfoForKeepAliveApp()),_e(this,"appstate-change",{appState:"aftershow"}),fe(this.container,this.name,Ie.AFTERSHOW)}onerror(e){_e(this,"statechange",{appState:De.LOAD_FAILED}),fe(this.container,this.name,Ie.ERROR,e)}parseHtmlString(e){var t;return(new((null===(t=this.sandBox)||void 0===t?void 0:t.proxyWindow)?this.sandBox.proxyWindow.DOMParser:lo.rawWindow.DOMParser)).parseFromString(e,"text/html").body}cloneContainer(e,t,n){return t&&e&&(e.innerHTML="",Array.from(n?this.parseHtmlString(t.innerHTML).childNodes:t.childNodes).forEach((t=>{e.appendChild(t)}))),e}createSandbox(){this.useSandbox&&!this.sandBox&&(this.sandBox=this.iframe?new Xn(this.name,this.url):new Un(this.name,this.url))}setAppState(e){var t;this.state=e,null===(t=this.sandBox)||void 0===t||t.setStaticAppState(e)}getAppState(){return this.state}setKeepAliveState(e){this.keepAliveState=e}getKeepAliveState(){return this.keepAliveState}isUnmounted(){return De.UNMOUNT===this.state}isHidden(){return Le.KEEP_ALIVE_HIDDEN===this.keepAliveState}getMicroAppGlobalHook(e){var t,n;const o=null===(n=null===(t=this.sandBox)||void 0===t?void 0:t.proxyWindow)||void 0===n?void 0:n[e];return _(o)?o:null}querySelector(e){return this.container?lo.rawElementQuerySelector.call(this.container,e):null}querySelectorAll(e){return this.container?lo.rawElementQuerySelectorAll.call(this.container,e):[]}getInlineModeState(e){var t;return null!==(t=this.iframe||e)&&void 0!==t&&t}}function Yn(e){var t,n;return null!==(n=null===(t=zn.get(e))||void 0===t?void 0:t.iframe)&&void 0!==n&&n}const Jn=new WeakMap;function Zn(e){var t;return null!==(t=Jn.get(e))&&void 0!==t?t:e}function eo(e,t){if(Jn.has(e))return Jn.get(e);if(P(e)){if(e.hasAttribute("exclude")){const t=document.createComment("style element with exclude attribute ignored by micro-app");return Jn.set(e,t),t}return t.scopecss&&!e.hasAttribute("ignore")?Re(e,t):e}if(E(e)){if(e.hasAttribute("exclude")||ft(e.getAttribute("href"),t.name)){const t=document.createComment("link element with exclude attribute ignored by micro-app");return Jn.set(e,t),t}if(e.hasAttribute("ignore")||_t(e.getAttribute("href"),t.name)||e.href&&_(vo.options.excludeAssetFilter)&&vo.options.excludeAssetFilter(e.href))return e;const{address:n,linkInfo:o,replaceComment:r}=Ue(e,null,t,!0);if(n&&o){const r=function(e,t,n,o){const r=Z("style"),i=()=>{ke(t,e,r,n,n.appSpace[t.name].attrs),Ce(o)};return n.code?I(i):we(e,t.name).then((e=>{n.code=e,i()})).catch((e=>{O(e,t.name),Ne(o)})),r}(n,t,o,e);return Jn.set(e,r),r}return r?(Jn.set(e,r),r):e}if(R(e)){if(e.src&&_(vo.options.excludeAssetFilter)&&vo.options.excludeAssetFilter(e.src))return e;const{replaceComment:n,address:o,scriptInfo:r}=dt(e,null,t,!0)||{};if(o&&r){const n=r.isExternal?function(e,t,n,o){const r=at(t,n)?Z("script"):document.createComment(`dynamic script with src='${e}' extract by micro-app`),i=()=>Ce(o),s=()=>{const s=Object.getOwnPropertyDescriptor(lo.rawDocument,"currentScript");s&&!s.configurable||Object.defineProperty(lo.rawDocument,"currentScript",{value:o,configurable:!0}),gt(e,t,n,i,r),!st(t,n)&&i()};return n.code||st(t,n)?I(s):we(e,t.name).then((e=>{n.code=e,s()})).catch((e=>{O(e,t.name),Ne(o)})),r}(o,t,r,e):function(e,t,n){const o=at(t,n)?Z("script"):document.createComment("dynamic inline script extract by micro-app");return gt(e,t,n,void 0,o),o}(o,t,r);return Jn.set(e,n),n}return n?(Jn.set(e,n),n):e}return e}function to(e,t,n,o,r){const i=no(n,o,e);if(i){if(!Yn(e.name)&&M(i)&&t!==lo.rawRemoveChild){const t=Object.getOwnPropertyDescriptor(o,"parentNode");t&&!t.configurable||o.__MICRO_APP_HAS_DPN__||a(o,{parentNode:{configurable:!0,get(){var t,n;const o=lo.rawParentNodeDesc.get.call(this);return M(o)&&e.container?(null===(n=(t=vo.options).getRootElementParentNode)||void 0===n?void 0:n.call(t,this,e.name))||document.body:o}},__MICRO_APP_HAS_DPN__:{configurable:!0,get:()=>!0}})}if(r&&!i.contains(r)){if(t===lo.rawInsertBefore&&n.contains(r)){const s=Array.from(n.childNodes).indexOf(r);if(i.childNodes[s])return oo(t,i,o,i.childNodes[s],e)}return lo.rawAppendChild.call(i,o)}return t!==lo.rawRemoveChild||i.contains(o)?oo(t,i,o,r,e):n.contains(o)?t.call(n,o):o}return oo(t,n,o,r,e)}function no(e,t,n){if(n){if(e===document.head)return n.iframe&&R(t)?n.sandBox.microHead:n.querySelector("micro-app-head");if(e===document.body||e===document.body.parentNode)return n.iframe&&R(t)?n.sandBox.microBody:n.querySelector("micro-app-body");if(n.iframe&&R(t))return n.sandBox.microBody}return null}function oo(e,t,n,o,r){return(i=e)===lo.rawAppend||i===lo.rawPrepend||i===lo.rawFragmentAppend||i===lo.rawFragmentPrepend?((null==r?void 0:r.iframe)&&R(n)&&(e===lo.rawFragmentAppend?e=lo.rawAppend:e===lo.rawFragmentPrepend&&(e=lo.rawPrepend)),e.call(t,n)):e.call(t,n,o);var i}function ro(e,t,n,o){const r=K();if(v(t)&&!t.__PURE_ELEMENT__&&(t.__MICRO_APP_NAME__||r)){kt(t,t.__MICRO_APP_NAME__||r);const i=zn.get(t.__MICRO_APP_NAME__);if(null==i?void 0:i.container)return P(t)&&e.getRootNode()instanceof ShadowRoot&&t.setAttribute("ignore","true"),function(e,t){b(t)&&(/^(img|script)$/i.test(t.tagName)?(t.hasAttribute("src")&&lo.rawSetAttribute.call(t,"src",B(t.getAttribute("src"),e.url)),t.hasAttribute("srcset")&&lo.rawSetAttribute.call(t,"srcset",B(t.getAttribute("srcset"),e.url))):/^(link|image)$/i.test(t.tagName)&&t.hasAttribute("href")&&lo.rawSetAttribute.call(t,"href",B(t.getAttribute("href"),e.url)))}(i,t),to(i,o,e,eo(t,i),n&&Zn(n))}return oo(o,e,t,n)}function io(){!function(){const e=lo.rawDocument,t=lo.rawRootDocument;function n(t){return function(e){return"[object ProxyDocument]"===u(e)}(t)?e:t}function o(t){var o,r;const i=n(this),s=K();return s&&t&&!te(t)&&e===i?null!==(r=null===(o=zn.get(s))||void 0===o?void 0:o.querySelector(t))&&void 0!==r?r:null:lo.rawQuerySelector.call(i,t)}function r(t){var o,r;const i=n(this),s=K();return s&&t&&!te(t)&&e===i?null!==(r=null===(o=zn.get(s))||void 0===o?void 0:o.querySelectorAll(t))&&void 0!==r?r:[]:lo.rawQuerySelectorAll.call(i,t)}t.prototype.createElement=function(e,t){return so(lo.rawCreateElement.call(n(this),e,t))},t.prototype.createElementNS=function(e,t,o){return so(lo.rawCreateElementNS.call(n(this),e,t,o))},t.prototype.createDocumentFragment=function(){return so(lo.rawCreateDocumentFragment.call(n(this)))},t.prototype.createComment=function(e){return so(lo.rawCreateComment.call(n(this),e))},t.prototype.querySelector=o,t.prototype.querySelectorAll=r,t.prototype.getElementById=function(e){const t=n(this);if(!K()||ee(e))return lo.rawGetElementById.call(t,e);try{return o.call(t,`#${e}`)}catch(n){return lo.rawGetElementById.call(t,e)}},t.prototype.getElementsByClassName=function(e){const t=n(this);if(!K()||ee(e))return lo.rawGetElementsByClassName.call(t,e);try{return r.call(t,`.${e}`)}catch(n){return lo.rawGetElementsByClassName.call(t,e)}},t.prototype.getElementsByTagName=function(e){var t;const o=n(this),i=K();if(!i||te(e)||ee(e)||!(null===(t=zn.get(i))||void 0===t?void 0:t.inline)&&/^script$/i.test(e))return lo.rawGetElementsByTagName.call(o,e);try{return r.call(o,e)}catch(t){return lo.rawGetElementsByTagName.call(o,e)}},t.prototype.getElementsByName=function(e){const t=n(this);if(!K()||ee(e))return lo.rawGetElementsByName.call(t,e);try{return r.call(t,`[name=${e}]`)}catch(n){return lo.rawGetElementsByName.call(t,e)}}}();const e=lo.rawRootElement,t=lo.rawRootNode,n=lo.rawDocumentFragment;function o(e){const t=X()||K();if((e===document.body||e===document.head)&&t){const n=zn.get(t);if(null==n?void 0:n.container){if(e===document.body)return n.querySelector("micro-app-body");if(e===document.head)return n.querySelector("micro-app-head")}}return e}function r(e,t,n,o,r){if(e){const e=X()||K();if(e&&Yn(e)){const n=zn.get(e);if(b(i=t)&&"MICRO-APP-HEAD"===i.tagName.toUpperCase())return n.sandBox.microHead[r](o);if(M(t))return n.sandBox.microBody[r](o)}}var i;return n}t.prototype.appendChild=function(e){return ro(this,e,null,lo.rawAppendChild)},t.prototype.insertBefore=function(e,t){return ro(this,e,t,lo.rawInsertBefore)},t.prototype.replaceChild=function(e,t){return ro(this,e,t,lo.rawReplaceChild)},t.prototype.removeChild=function(e){if(null==e?void 0:e.__MICRO_APP_NAME__){const t=zn.get(e.__MICRO_APP_NAME__);if(null==t?void 0:t.container)return to(t,lo.rawRemoveChild,this,Zn(e));try{return lo.rawRemoveChild.call(this,e)}catch(t){return(null==e?void 0:e.parentNode)&&lo.rawRemoveChild.call(e.parentNode,e)}}return lo.rawRemoveChild.call(this,e)},n.prototype.append=e.prototype.append=function(...e){let t=0;for(;t<e.length;){let n=e[t];n=v(n)?n:lo.rawCreateTextNode.call(lo.rawDocument,n),ro(this,so(n),null,S(this)?lo.rawFragmentAppend:lo.rawAppend),t++}},n.prototype.prepend=e.prototype.prepend=function(...e){let t=e.length;for(;t>0;){let n=e[t-1];n=v(n)?n:lo.rawCreateTextNode.call(lo.rawDocument,n),ro(this,so(n),null,S(this)?lo.rawFragmentPrepend:lo.rawPrepend),t--}},e.prototype.insertAdjacentElement=function(e,t){var n;if((null==t?void 0:t.__MICRO_APP_NAME__)&&b(t)){const o=zn.get(t.__MICRO_APP_NAME__);if(null==o?void 0:o.container){const r=eo(t,o);if(!b(r))return t;const i=null!==(n=no(this,r,o))&&void 0!==n?n:this;return lo.rawInsertAdjacentElement.call(i,e,r)}}return lo.rawInsertAdjacentElement.call(this,e,t)},e.prototype.querySelector=function(e){var t;const n=null!==(t=o(this))&&void 0!==t?t:this,i=lo.rawElementQuerySelector.call(n,e);return r(h(i)&&n!==this,n,i,e,"querySelector")},e.prototype.querySelectorAll=function(e){var t;const n=null!==(t=o(this))&&void 0!==t?t:this,i=lo.rawElementQuerySelectorAll.call(n,e);return r(!i.length&&n!==this,n,i,e,"querySelectorAll")},e.prototype.setAttribute=function(t,n){if(/^micro-app(-\S+)?/i.test(this.tagName)&&"data"===t&&this.setAttribute!==e.prototype.setAttribute)this.setAttribute(t,n);else{const e=this.__MICRO_APP_NAME__||K();if(e&&zn.has(e)&&(("src"===t||"srcset"===t)&&/^(img|script|video|audio|source|embed)$/i.test(this.tagName)||"href"===t&&/^(link|image)$/i.test(this.tagName))){n=B(n,zn.get(e).url)}lo.rawSetAttribute.call(this,t,n)}},s(t.prototype,"parentNode",{configurable:!0,enumerable:!0,get(){var e,t,n;const o=X()||K();if(o&&this===lo.rawDocument.firstElementChild){const r=null===(n=null===(t=null===(e=zn.get(o))||void 0===e?void 0:e.sandBox)||void 0===t?void 0:t.proxyWindow)||void 0===n?void 0:n.document;if(r)return r}return lo.rawParentNodeDesc.get.call(this)}}),s(e.prototype,"innerHTML",{configurable:!0,enumerable:!0,get(){return lo.rawInnerHTMLDesc.get.call(this)},set(e){lo.rawInnerHTMLDesc.set.call(this,e);const t=this.__MICRO_APP_NAME__||K();Array.from(this.children).forEach((e=>{b(e)&&t&&kt(e,t)}))}}),t.prototype.cloneNode=function(e){return kt(lo.rawCloneNode.call(this,e),this.__MICRO_APP_NAME__)}}function so(e){return kt(e,K())}function ao(){J(),function(){const e=lo.rawRootDocument;e.prototype.createElement=lo.rawCreateElement,e.prototype.createElementNS=lo.rawCreateElementNS,e.prototype.createDocumentFragment=lo.rawCreateDocumentFragment,e.prototype.querySelector=lo.rawQuerySelector,e.prototype.querySelectorAll=lo.rawQuerySelectorAll,e.prototype.getElementById=lo.rawGetElementById,e.prototype.getElementsByClassName=lo.rawGetElementsByClassName,e.prototype.getElementsByTagName=lo.rawGetElementsByTagName,e.prototype.getElementsByName=lo.rawGetElementsByName}();const e=lo.rawRootElement,t=lo.rawRootNode;t.prototype.appendChild=lo.rawAppendChild,t.prototype.insertBefore=lo.rawInsertBefore,t.prototype.replaceChild=lo.rawReplaceChild,t.prototype.removeChild=lo.rawRemoveChild,t.prototype.cloneNode=lo.rawCloneNode,e.prototype.append=lo.rawAppend,e.prototype.prepend=lo.rawPrepend,e.prototype.querySelector=lo.rawElementQuerySelector,e.prototype.querySelectorAll=lo.rawElementQuerySelectorAll,e.prototype.setAttribute=lo.rawSetAttribute,s(t.prototype,"parentNode",lo.rawParentNodeDesc),s(e.prototype,"innerHTML",lo.rawInnerHTMLDesc)}let co=!1;const lo={activeSandbox:0};function uo(){if(t){const e=window.rawWindow||Function("return window")(),t=window.rawDocument||Function("return document")(),n=e.Document||Function("return Document")(),o=e.Element,r=e.Node,s=e.EventTarget,a=e.DocumentFragment,c=r.prototype.appendChild,l=r.prototype.insertBefore,u=r.prototype.replaceChild,p=r.prototype.removeChild,h=o.prototype.setAttribute,d=o.prototype.append,m=o.prototype.prepend,f=a.prototype.append,_=a.prototype.prepend,w=r.prototype.cloneNode,g=o.prototype.querySelector,A=o.prototype.querySelectorAll,y=o.prototype.insertAdjacentElement,b=Object.getOwnPropertyDescriptor(o.prototype,"innerHTML"),v=Object.getOwnPropertyDescriptor(r.prototype,"parentNode"),E=n.prototype.createElement,P=n.prototype.createElementNS,R=n.prototype.createTextNode,S=n.prototype.createDocumentFragment,M=n.prototype.createComment,C=n.prototype.querySelector,N=n.prototype.querySelectorAll,O=n.prototype.getElementById,D=n.prototype.getElementsByClassName,I=n.prototype.getElementsByTagName,x=n.prototype.getElementsByName,L=new Proxy(e.Image,{construct:(e,t)=>kt(new e(...t),K())}),T=e.setInterval,W=e.setTimeout,U=e.clearInterval,B=e.clearTimeout,k=e.history.pushState,H=e.history.replaceState,F=s.prototype.addEventListener,j=s.prototype.removeEventListener,$=s.prototype.dispatchEvent;window.__MICRO_APP_BASE_APPLICATION__=!0,i(lo,{supportModuleScript:"noModule"in document.createElement("script"),rawWindow:e,rawDocument:t,rawRootDocument:n,rawRootElement:o,rawRootNode:r,rawDocumentFragment:a,rawSetAttribute:h,rawAppendChild:c,rawInsertBefore:l,rawReplaceChild:u,rawRemoveChild:p,rawAppend:d,rawPrepend:m,rawFragmentAppend:f,rawFragmentPrepend:_,rawCloneNode:w,rawElementQuerySelector:g,rawElementQuerySelectorAll:A,rawInsertAdjacentElement:y,rawInnerHTMLDesc:b,rawParentNodeDesc:v,rawCreateElement:E,rawCreateElementNS:P,rawCreateDocumentFragment:S,rawCreateTextNode:R,rawCreateComment:M,rawQuerySelector:C,rawQuerySelectorAll:N,rawGetElementById:O,rawGetElementsByClassName:D,rawGetElementsByTagName:I,rawGetElementsByName:x,ImageProxy:L,rawSetInterval:T,rawSetTimeout:W,rawClearInterval:U,rawClearTimeout:B,rawPushState:k,rawReplaceState:H,rawAddEventListener:F,rawRemoveEventListener:j,rawDispatchEvent:$}),function(){if(!co){co=!0;const e=Z("style");lo.rawSetAttribute.call(e,"type","text/css"),e.textContent=`\n${vo.tagName}, micro-app-body { display: block; } \nmicro-app-head { display: none; }`,lo.rawDocument.head.appendChild(e)}}()}}function po(t){class n extends HTMLElement{constructor(){super(...arguments),this.isWaiting=!1,this.cacheData=null,this.connectedCount=0,this.connectStateMap=new Map,this.appName="",this.appUrl="",this.ssrUrl="",this.version=e,this.handleAttributeUpdate=()=>{this.isWaiting=!1;const e=W(this.getAttribute("name")),t=T(this.getAttribute("url"),this.appName);if(this.legalAttribute("name",e)&&this.legalAttribute("url",t)){const n=zn.get(e);if(e!==this.appName&&n&&!n.isUnmounted()&&!n.isHidden()&&!n.isPrefetch)return this.setAttribute("name",this.appName),O(`app name conflict, an app named ${e} is running`);e===this.appName&&t===this.appUrl||(e===this.appName?this.unmount(!0,(()=>{this.actionsForAttributeChange(e,t,n)})):this.getKeepAliveModeResult()?(this.handleHiddenKeepAliveApp(),this.actionsForAttributeChange(e,t,n)):this.unmount(!1,(()=>{this.actionsForAttributeChange(e,t,n)})))}else e!==this.appName&&this.setAttribute("name",this.appName)}}static get observedAttributes(){return["name","url"]}connectedCallback(){Object.getPrototypeOf(this)!==n.prototype&&Object.setPrototypeOf(this,n.prototype);const e=++this.connectedCount;this.connectStateMap.set(e,!0);const t=this.appName&&this.appUrl;I((()=>{this.connectStateMap.get(e)&&(fe(this,this.appName,Ie.CREATED),t&&this.handleConnected())}))}disconnectedCallback(){this.connectStateMap.set(this.connectedCount,!1),this.handleDisconnected()}reload(e){return new Promise((t=>{const n=()=>{this.removeEventListener(Ie.MOUNTED,n),this.removeEventListener(Ie.AFTERSHOW,n),t(!0)};this.addEventListener(Ie.MOUNTED,n),this.addEventListener(Ie.AFTERSHOW,n),this.handleDisconnected(e,(()=>{this.handleConnected()}))}))}handleDisconnected(e=!1,t){const n=zn.get(this.appName);!n||n.isUnmounted()||n.isHidden()||(this.getKeepAliveModeResult()&&!e?this.handleHiddenKeepAliveApp(t):this.unmount(e,t))}attributeChangedCallback(e,t,n){if(this.legalAttribute(e,n)&&this[e===Oe.NAME?"appName":"appUrl"]!==n)if(e!==Oe.URL||this.appUrl&&this.connectStateMap.get(this.connectedCount))if(e!==Oe.NAME||this.appName&&this.connectStateMap.get(this.connectedCount))this.isWaiting||(this.isWaiting=!0,I(this.handleAttributeUpdate));else{const e=W(n);if(!e)return O(`Invalid attribute name ${n}`,this.appName);this.cacheData&&(vo.setData(e,this.cacheData),this.cacheData=null),this.appName=e,e!==n&&this.setAttribute("name",this.appName),this.handleInitialNameAndUrl()}else{if(!(n=T(n,this.appName)))return O(`Invalid attribute url ${n}`,this.appName);this.appUrl=n,this.handleInitialNameAndUrl()}}handleInitialNameAndUrl(){this.connectStateMap.get(this.connectedCount)&&this.handleConnected()}handleConnected(){if(this.appName&&this.appUrl)if(this.getDisposeResult("shadowDOM")&&!this.shadowRoot&&_(this.attachShadow)&&this.attachShadow({mode:"open"}),this.updateSsrUrl(this.appUrl),zn.has(this.appName)){const e=zn.get(this.appName),t=e.ssrUrl||e.url,n=this.ssrUrl||this.appUrl;e.isHidden()&&e.url===this.appUrl?this.handleShowKeepAliveApp(e):t===n&&(e.isUnmounted()||e.isPrefetch&&this.sameCoreOptions(e))?this.handleMount(e):e.isPrefetch||e.isUnmounted()?this.handleCreateApp():O(`app name conflict, an app named ${this.appName} with url ${t} is running`)}else this.handleCreateApp()}actionsForAttributeChange(e,t,n){var o;this.updateSsrUrl(t),this.appName=e,this.appUrl=t,(null!==(o=this.shadowRoot)&&void 0!==o?o:this).innerHTML="",e!==this.getAttribute("name")&&this.setAttribute("name",this.appName),n?n.isHidden()?n.url===this.appUrl?this.handleShowKeepAliveApp(n):O(`app name conflict, an app named ${this.appName} is running`):n.url===this.appUrl&&n.ssrUrl===this.ssrUrl?this.handleMount(n):this.handleCreateApp():this.handleCreateApp()}legalAttribute(e,t){return!(!d(t)||!t)||(O(`unexpected attribute ${e}, please check again`,this.appName),!1)}handleCreateApp(){const e=()=>{var e;return new Vn({name:this.appName,url:this.appUrl,container:null!==(e=this.shadowRoot)&&void 0!==e?e:this,scopecss:this.useScopecss(),useSandbox:this.useSandbox(),inline:this.getDisposeResult("inline"),iframe:this.getDisposeResult("iframe"),ssrUrl:this.ssrUrl,routerMode:this.getMemoryRouterMode()})},t=zn.get(this.appName);t?t.isPrerender?this.unmount(!0,e):(t.actionsForCompletelyDestroy(),e()):e()}handleMount(e){e.isPrefetch=!1,e.setAppState(De.BEFORE_MOUNT),I((()=>this.mount(e)))}mount(e){var t;e.mount({container:null!==(t=this.shadowRoot)&&void 0!==t?t:this,inline:this.getDisposeResult("inline"),routerMode:this.getMemoryRouterMode(),baseroute:this.getBaseRouteCompatible(),defaultPage:this.getDefaultPage(),disablePatchRequest:this.getDisposeResult("disable-patch-request"),fiber:this.getDisposeResult("fiber")})}unmount(e,t){const n=zn.get(this.appName);n&&!n.isUnmounted()&&n.unmount({destroy:e||this.getDestroyCompatibleResult(),clearData:this.getDisposeResult("clear-data"),keepRouteState:this.getDisposeResult("keep-router-state"),unmountcb:t})}handleHiddenKeepAliveApp(e){const t=zn.get(this.appName);!t||t.isUnmounted()||t.isHidden()||t.hiddenKeepAliveApp(e)}handleShowKeepAliveApp(e){I((()=>{var t;return e.showKeepAliveApp(null!==(t=this.shadowRoot)&&void 0!==t?t:this)}))}getDisposeResult(e){return(this.compatibleProperties(e)||!!vo.options[e])&&this.compatibleDisableProperties(e)}compatibleProperties(e){return"disable-scopecss"===e?this.hasAttribute("disable-scopecss")||this.hasAttribute("disableScopecss"):"disable-sandbox"===e?this.hasAttribute("disable-sandbox")||this.hasAttribute("disableSandbox"):this.hasAttribute(e)}compatibleDisableProperties(e){return"disable-scopecss"===e?"false"!==this.getAttribute("disable-scopecss")&&"false"!==this.getAttribute("disableScopecss"):"disable-sandbox"===e?"false"!==this.getAttribute("disable-sandbox")&&"false"!==this.getAttribute("disableSandbox"):"false"!==this.getAttribute(e)}useScopecss(){return!(this.getDisposeResult("disable-scopecss")||this.getDisposeResult("shadowDOM"))}useSandbox(){return!this.getDisposeResult("disable-sandbox")}sameCoreOptions(e){return e.scopecss===this.useScopecss()&&e.useSandbox===this.useSandbox()&&e.iframe===this.getDisposeResult("iframe")}getBaseRouteCompatible(){var e,t;return null!==(t=null!==(e=this.getAttribute("baseroute"))&&void 0!==e?e:this.getAttribute("baseurl"))&&void 0!==t?t:""}getDestroyCompatibleResult(){return this.getDisposeResult("destroy")||this.getDisposeResult("destory")}getKeepAliveModeResult(){return this.getDisposeResult("keep-alive")&&!this.getDestroyCompatibleResult()}updateSsrUrl(e){if(this.getDisposeResult("ssr"))if(this.getDisposeResult("disable-memory-router")||this.getDisposeResult("disableSandbox")){const t=lo.rawWindow.location;this.ssrUrl=B(t.pathname+t.search,e)}else{let t=function(e,t){const n=en(e);if(!n)return"";const o=x(n,t);return o.origin+o.pathname+o.search}(this.appName,e);const n=this.getDefaultPage();if(!t&&n){const o=x(n,e);t=o.origin+o.pathname+o.search}this.ssrUrl=t}else this.ssrUrl&&(this.ssrUrl="")}getDefaultPage(){return vn.getDefaultPage(this.appName)||this.getAttribute("default-page")||this.getAttribute("defaultPage")||""}getMemoryRouterMode(){return pn(this.getAttribute("router-mode"),this.compatibleProperties("disable-memory-router")&&this.compatibleDisableProperties("disable-memory-router"))}setAttribute(e,t){if("data"===e)if(w(t)){const e={};Object.getOwnPropertyNames(t).forEach((n=>{d(n)&&0===n.indexOf("__")||(e[n]=t[n])})),this.data=e}else"[object Object]"!==t&&D("property data must be an object",this.appName);else lo.rawSetAttribute.call(this,e,t)}getRouterEventDelay(){let e=parseInt(this.getAttribute("router-event-delay"));return isNaN(e)&&(e=parseInt(_(vo.options["router-event-delay"])?vo.options["router-event-delay"](this.appName):vo.options["router-event-delay"])),isNaN(e)?0:e}set data(e){this.appName?vo.setData(this.appName,e):this.cacheData=e}get data(){return this.appName?vo.getData(this.appName,!0):this.cacheData?this.cacheData:null}get publicPath(){return U(this.appUrl)}get baseRoute(){return this.getBaseRouteCompatible()}}window.customElements.define(t,n)}function ho(e,n){if(!t)return O("preFetch is only supported in browser environment");H((()=>{const t=f(n)?n:vo.options.prefetchDelay;setTimeout((()=>{!function(e){_(e)&&(e=e()),r(e)&&e.reduce(((e,t)=>e.then((()=>{return e=t,F((t=>{var n,o,r,s,a,c;if(w(e)&&navigator.onLine)if(e.name=W(e.name),e.url=T(e.url,e.name),e.name&&e.url&&!zn.has(e.name)){const l=new Vn({name:e.name,url:e.url,isPrefetch:!0,scopecss:!(null!==(o=null!==(n=e["disable-scopecss"])&&void 0!==n?n:e.disableScopecss)&&void 0!==o?o:vo.options["disable-scopecss"]),useSandbox:!(null!==(s=null!==(r=e["disable-sandbox"])&&void 0!==r?r:e.disableSandbox)&&void 0!==s?s:vo.options["disable-sandbox"]),inline:null!==(a=e.inline)&&void 0!==a?a:vo.options.inline,iframe:null!==(c=e.iframe)&&void 0!==c?c:vo.options.iframe,prefetchLevel:e.level&&Fe.includes(e.level)?e.level:vo.options.prefetchLevel&&Fe.includes(vo.options.prefetchLevel)?vo.options.prefetchLevel:2}),u=l.onLoad,p=l.onLoadError;l.onLoad=n=>{l.isPrerender&&i(n,{defaultPage:e["default-page"],routerMode:pn(e["router-mode"]),baseroute:e.baseroute,disablePatchRequest:e["disable-patch-request"]}),t(),u.call(l,n)},l.onLoadError=(...e)=>{t(),p.call(l,...e)}}else t();else t()}));var e}))),Promise.resolve())}(e)}),f(t)?t:3e3)}))}function mo(e,t,n){if(r(e)){const o=e.filter((e=>d(e)&&C(e,t)&&!n.hasInfo(e)));k(o.map((e=>we(e))),(e=>{const r=o[e.index];"js"===t?n.hasInfo(r)||n.setInfo(r,{code:e.data,isExternal:!1,appSpace:{}}):n.hasInfo(r)||n.setInfo(r,{code:e.data,appSpace:{}})}),(e=>{O(e)}))}}function fo({excludeHiddenApp:e=!1,excludePreRender:t=!1}={}){const n=[];return zn.forEach(((o,r)=>{o.isUnmounted()||o.isPrefetch&&(!o.isPrerender||t)||e&&o.isHidden()||n.push(r)})),n}function _o(){return Array.from(zn.keys())}function wo(e,t){const n=zn.get(W(e));return new Promise((o=>{if(n)if(n.isUnmounted()||n.isPrefetch)n.isPrerender?n.unmount({destroy:!!(null==t?void 0:t.destroy),clearData:!!(null==t?void 0:t.clearData),keepRouteState:!1,unmountcb:o.bind(null,!0)}):((null==t?void 0:t.destroy)&&n.actionsForCompletelyDestroy(),o(!0));else if(n.isHidden())(null==t?void 0:t.destroy)?n.unmount({destroy:!0,clearData:!0,keepRouteState:!0,unmountcb:o.bind(null,!0)}):(null==t?void 0:t.clearAliveState)?n.unmount({destroy:!1,clearData:!!t.clearData,keepRouteState:!0,unmountcb:o.bind(null,!0)}):o(!0);else{const e=ne(n.container),r=()=>{e.removeEventListener(Ie.UNMOUNT,r),e.removeEventListener(Ie.AFTERHIDDEN,i),o(!0)},i=()=>{e.removeEventListener(Ie.UNMOUNT,r),e.removeEventListener(Ie.AFTERHIDDEN,i),o(!0)};if(e.addEventListener(Ie.UNMOUNT,r),e.addEventListener(Ie.AFTERHIDDEN,i),null==t?void 0:t.destroy){let t,n;e.hasAttribute("destroy")&&(t=e.getAttribute("destroy")),e.hasAttribute("destory")&&(n=e.getAttribute("destory")),e.setAttribute("destroy","true"),e.parentNode.removeChild(e),e.removeAttribute("destroy"),d(t)&&e.setAttribute("destroy",t),d(n)&&e.setAttribute("destory",n)}else if((null==t?void 0:t.clearAliveState)&&e.hasAttribute("keep-alive")){const n=e.getAttribute("keep-alive");e.removeAttribute("keep-alive");let o=null;t.clearData&&(o=e.getAttribute("clear-data"),e.setAttribute("clear-data","true")),e.parentNode.removeChild(e),e.setAttribute("keep-alive",n),d(o)&&e.setAttribute("clear-data",o)}else{let n=null;(null==t?void 0:t.clearData)&&(n=e.getAttribute("clear-data"),e.setAttribute("clear-data","true")),e.parentNode.removeChild(e),d(n)&&e.setAttribute("clear-data",n)}}else D(`app ${e} does not exist when unmountApp`),o(!1)}))}function go(e){return Array.from(zn.keys()).reduce(((t,n)=>t.then((()=>wo(n,e)))),Promise.resolve(!0))}function Ao(e,t){return new Promise((n=>{const o=zn.get(W(e));if(o){const r=o.container&&ne(o.container);r?n(r.reload(t)):(D(`app ${e} is not rendered, cannot use reload`),n(!1))}else D(`app ${e} does not exist when reload app`),n(!1)}))}function yo(e){return new Promise((t=>{if(!w(e))return O("renderApp options must be an object");const n=b(e.container)?e.container:d(e.container)?document.querySelector(e.container):null;if(!b(n))return O("Target container is not a DOM element.");const o=Z(vo.tagName);for(const t in e)if("onDataChange"===t)_(e[t])&&o.addEventListener("datachange",e[t]);else if("lifeCycles"===t){const n=e[t];if(w(n))for(const e in n)e.toUpperCase()in Ie&&_(n[e])&&o.addEventListener(e.toLowerCase(),n[e])}else"container"!==t&&o.setAttribute(t,e[t]);const r=()=>{s(),t(!0)},i=()=>{s(),t(!1)},s=()=>{o.removeEventListener(Ie.MOUNTED,r),o.removeEventListener(Ie.ERROR,i)};o.addEventListener(Ie.MOUNTED,r),o.addEventListener(Ie.ERROR,i),n.appendChild(o)}))}class bo extends St{constructor(){super(...arguments),this.tagName="micro-app",this.hasInit=!1,this.options={},this.router=vn,this.preFetch=ho,this.unmountApp=wo,this.unmountAllApps=go,this.getActiveApps=fo,this.getAllApps=_o,this.reload=Ao,this.renderApp=yo}start(e){var n,o,r;if(!t||!window.customElements)return O("micro-app is not supported in this environment");if(this.hasInit)return O("microApp.start executed repeatedly");if(this.hasInit=!0,null==e?void 0:e.tagName){if(!/^micro-app(-\S+)?/.test(e.tagName))return O(`${e.tagName} is invalid tagName`);this.tagName=e.tagName}if(uo(),window.customElements.get(this.tagName))return D(`element ${this.tagName} is already defined`);if(w(e)&&(this.options=e,e["disable-scopecss"]=null!==(n=e["disable-scopecss"])&&void 0!==n?n:e.disableScopecss,e["disable-sandbox"]=null!==(o=e["disable-sandbox"])&&void 0!==o?o:e.disableSandbox,e.preFetchApps&&ho(e.preFetchApps),e.globalAssets&&(w(r=e.globalAssets)&&H((()=>{mo(r.js,"js",We.script),mo(r.css,"css",We.link)}))),w(e.plugins))){const t=e.plugins.modules;if(w(t))for(const e in t){const n=W(e);n&&e!==n&&(t[n]=t[e],delete t[e])}}po(this.tagName)}}const vo=new bo;export default vo;export{Mt as EventCenterForMicroApp,bo as MicroApp,fo as getActiveApps,_o as getAllApps,ho as preFetch,Z as pureCreateElement,Ao as reload,J as removeDomScope,yo as renderApp,go as unmountAllApps,wo as unmountApp,e as version};